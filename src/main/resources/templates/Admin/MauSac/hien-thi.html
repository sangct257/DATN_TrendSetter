<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/fragments/head :: head"></head>
<body class="hold-transition skin-blue sidebar-mini">
<!-- Site wrapper -->
<div class="wrapper">

    <div th:replace="admin/fragments/header :: header"></div>
    <!-- =============================================== -->

    <!-- Left side column. contains the sidebar -->
    <div th:replace="admin/fragments/sidebar :: sidebar"></div>

    <!-- =============================================== -->

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                Danh S√°ch M√†u S·∫Øc
            </h1>
            <ol class="breadcrumb">
                <li><a href="/admin"><i class="fa fa-dashboard"></i> Home</a></li>
                <li><a href="#">M√†u S·∫Øc</a></li>
            </ol>

            <!-- Toast Notification -->
            <!-- Toast Th√¥ng B√°o -->
            <div class="toast-container position-fixed top-0 end-0 p-3">
                <div id="toast-message" class="toast align-items-center text-bg-primary border-0 fade hide" role="alert"
                     aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <span id="toast-text">Vui l√≤ng ch·ªù...</span>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                                aria-label="Close"></button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main content -->
        <section class="content">

            <!-- Default box -->
            <div class="box">
                <div class="box-body">
                    <!--Th√™m M√†u S·∫Øc-->
                    <div class="d-flex justify-content-end mb-3">
                        <!-- N√∫t m·ªü modal Th√™m M√†u S·∫Øc -->
                        <button class="btn btn-success fw-bold" data-bs-toggle="modal" data-bs-target="#modalAddMauSac">
                            <i class="bi bi-plus-lg"></i> Th√™m M√†u S·∫Øc
                        </button>
                    </div>

                    <!-- Modal Th√™m M√†u S·∫Øc -->
                    <div class="modal fade" id="modalAddMauSac" tabindex="-1" aria-labelledby="addMauSacLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="addMauSacLabel">Th√™m M√†u S·∫Øc</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addMauSacForm">
                                        <div class="mb-3">
                                            <label class="form-label">T√™n M√†u S·∫Øc</label>
                                            <input type="text" class="form-control" id="tenMauSac" required readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">M√£ M√†u</label>
                                            <div class="d-flex align-items-center">
                                                <input type="color" class="form-control form-control-color me-2" id="maMauSac" value="#000000">
                                                <input type="text" class="form-control w-25" id="hexColor" value="#000000" readonly>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Tr·∫°ng Th√°i</label>
                                            <select class="form-select" id="trangThai">
                                                <option value="ƒêang Ho·∫°t ƒê·ªông">ƒêang Ho·∫°t ƒê·ªông</option>
                                                <option value="Ng·ª´ng Ho·∫°t ƒê·ªông">Ng·ª´ng Ho·∫°t ƒê·ªông</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                                    <button type="button" class="btn btn-success" onclick="saveMauSac()">L∆∞u</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <table id="productTable"
                           class="table table-striped table-bordered">
                        <thead class="table-dark">
                        <tr class="text-center">
                            <th class="text-center">#</th>
                            <th class="text-center">M√£ M√†u S·∫Øc</th>
                            <th class="text-center">T√™n M√†u S·∫Øc</th>
                            <th class="text-center">Tr·∫°ng Th√°i</th>
                            <th class="text-center">Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="mauSac, status : ${mauSac}">
                            <td class="text-center">
                                <input type="hidden" th:value="${mauSac.id}">
                                <span th:text="${status.index + 1}"></span>
                            </td>
                            <td class="text-center">
                                <button th:text="${mauSac.maMauSac}"
                                      th:style="'background-color:' + ${mauSac.maMauSac}"
                                      style="opacity: 0; user-select: none; width: 40px; height: 40px; flex-shrink: 0;"
                                      class="rounded border border-secondary d-flex align-items-center justify-content-center shadow mx-auto">
                                </button>
                            </td>
                            <td class="text-center" th:text="${mauSac.tenMauSac}"></td>
                            <td class="text-center">
                                <button th:class="${mauSac.trangThai == 'ƒêang Ho·∫°t ƒê·ªông' ? 'badge bg-success' : 'badge bg-danger'}"
                                        th:text="${mauSac.trangThai}">
                                </button>
                            </td>
                            <td class="text-center">
                                <!-- N√∫t m·ªü modal Chi Ti·∫øt -->
                                <button class="btn btn-primary btn-sm fw-bold me-2"
                                        onclick="openMauSacDetailModal(this)">
                                    <i class="bi bi-eye"></i> Chi Ti·∫øt
                                </button>

                                <button class="btn btn-danger btn-sm fw-bold" onclick="deleteMauSac(this)">
                                    <i class="bi bi-trash"></i> X√≥a
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <!-- Modal Chi Ti·∫øt M√†u S·∫Øc -->
                    <div class="modal fade" id="modalMauSacDetail" tabindex="-1" aria-labelledby="mauSacDetailLabel"
                         aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="mauSacDetailLabel">Chi Ti·∫øt M√†u S·∫Øc</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="updateMauSacForm">
                                        <input type="hidden" id="modalMauSacId">
                                        <div class="mb-3">
                                            <label class="form-label">T√™n M√†u S·∫Øc</label>
                                            <input type="text" id="modalMauSacName" class="form-control" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">M√£ M√†u</label>
                                            <div class="d-flex align-items-center">
                                                <input type="color" class="form-control form-control-color me-2" id="modalMauSacColor"
                                                       onchange="document.getElementById('modalMauSacHex').value = this.value;">
                                                <input type="text" class="form-control w-25" id="modalMauSacHex" readonly>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Tr·∫°ng Th√°i</label>
                                            <select id="modalMauSacStatus" class="form-select">
                                                <option value="ƒêang Ho·∫°t ƒê·ªông">ƒêang Ho·∫°t ƒê·ªông</option>
                                                <option value="Ng·ª´ng Ho·∫°t ƒê·ªông">Ng·ª´ng Ho·∫°t ƒê·ªông</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                                    <button type="button" class="btn btn-success" onclick="updateMauSac()">Ch·ªânh S·ª≠a</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <!-- /.box -->

        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <div th:replace="admin/fragments/footer :: footer"></div>


</div>
<!-- ./wrapper -->

<!-- jQuery 3 -->

<div th:replace="admin/fragments/script :: script"></div>

<!--Hi·ªÉn th·ªã Toast Notification-->
<script>
    function showToast(message, type, duration = 3000) {
        const toast = document.getElementById("toast-message");
        const toastText = document.getElementById("toast-text");

        // Reset tr·∫°ng th√°i
        toast.classList.remove("text-bg-primary", "text-bg-success", "text-bg-danger", "hide");
        toast.classList.add(`text-bg-${type}`);
        toast.style.opacity = "1";
        toast.classList.add("show");
        toastText.textContent = message;

        // T·ª± ƒë·ªông ·∫©n sau kho·∫£ng th·ªùi gian ƒë√£ ƒë·ªãnh
        setTimeout(hideToast, duration);
    }

    function hideToast() {
        const toast = document.getElementById("toast-message");
        toast.style.opacity = "0";
        setTimeout(() => {
            toast.classList.remove("show");
            toast.classList.add("hide");
        }, 300);
    }
</script>

<script>
    document.getElementById("maMauSac").addEventListener("input", function () {
        let hexValue = this.value;
        document.getElementById("hexColor").value = hexValue;
        getColorName(hexValue, "tenMauSac");
    });

    document.getElementById("modalMauSacColor").addEventListener("input", function () {
        let hexValue = this.value;
        document.getElementById("modalMauSacHex").value = hexValue;
        getColorName(hexValue, "modalMauSacName");
    });

    async function getColorName(hex, outputId) {
        try {
            console.log("üé® M√£ m√†u HEX g·ª≠i ƒëi:", hex);
            const response = await fetch(`https://www.thecolorapi.com/id?hex=${hex.replace("#", "")}`);
            if (!response.ok) throw new Error("‚ùå API TheColorAPI kh√¥ng ph·∫£n h·ªìi!");

            const data = await response.json();
            console.log("üì¶ JSON tr·∫£ v·ªÅ:", data);

            let englishName = data.name?.value || "Kh√¥ng x√°c ƒë·ªãnh";
            let translatedName = await translateColorFree(englishName);
            document.getElementById(outputId).value = translatedName;
        } catch (error) {
            console.error("üö® L·ªói trong getColorName():", error);
            document.getElementById(outputId).value = "Kh√¥ng x√°c ƒë·ªãnh";
        }
    }

    async function translateColorFree(text) {
        try {
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=vi&dt=t&q=${encodeURIComponent(text)}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error("L·ªói API Google D·ªãch");
            const result = await response.json();
            return result[0][0][0] || text;
        } catch (error) {
            console.error("L·ªói khi d·ªãch m√†u s·∫Øc:", error);
            return text;
        }
    }

    function saveMauSac() {
        let data = {
            tenMauSac: document.getElementById("tenMauSac").value.trim(),
            maMauSac: document.getElementById("maMauSac").value.trim(),
            trangThai: document.getElementById("trangThai").value.trim()
        };

        if (!data.tenMauSac) {
            showToast("Vui l√≤ng nh·∫≠p t√™n m√†u s·∫Øc!", "danger");
            return;
        }

        fetchData("/api/mau-sac/add", data, "Th√™m m√†u s·∫Øc th√†nh c√¥ng!", "POST");
    }

    function updateMauSac() {
        let updatedMauSac = {
            id: document.getElementById("modalMauSacId").value,
            tenMauSac: document.getElementById("modalMauSacName").value.trim(),
            maMauSac: document.getElementById("modalMauSacColor").value.trim(),
            trangThai: document.getElementById("modalMauSacStatus").value.trim()
        };

        fetchData("/api/mau-sac/update", updatedMauSac, "C·∫≠p nh·∫≠t m√†u s·∫Øc th√†nh c√¥ng!", "PUT");
    }

    function fetchData(url, data, successMessage, method) {
        fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
            .then(response => response.text()) // ƒê·ªçc d∆∞·ªõi d·∫°ng text
            .then(text => {
                try {
                    return JSON.parse(text); // C·ªë g·∫Øng chuy·ªÉn th√†nh JSON
                } catch {
                    return { message: text }; // N·∫øu l·ªói, coi nh∆∞ m·ªôt object c√≥ message
                }
            })
            .then(result => {
                if (result.error) {
                    showToast("L·ªói: " + result.error, "danger");
                } else {
                    showToast(result.message || successMessage, "success");
                    setTimeout(() => location.reload(), 2000);
                }
            })
            .catch(error => {
                console.error("L·ªói h·ªá th·ªëng:", error);
                showToast("L·ªói h·ªá th·ªëng, vui l√≤ng th·ª≠ l·∫°i!", "danger");
            });
    }

    function openMauSacDetailModal(button) {
        let row = button.closest("tr");
        document.getElementById("modalMauSacId").value = row.querySelector("td input[type='hidden']").value;
        document.getElementById("modalMauSacName").value = row.cells[2].innerText;
        document.getElementById("modalMauSacColor").value = row.cells[1].innerText.trim();
        document.getElementById("modalMauSacStatus").value = row.cells[3].innerText.trim();
        new bootstrap.Modal(document.getElementById("modalMauSacDetail")).show();
    }

    function deleteMauSac(button) {
        let row = button.closest("tr");
        let hiddenInput = row.querySelector("td input[type='hidden']");

        if (!hiddenInput) {
            showToast("Kh√¥ng t√¨m th·∫•y ID m√†u s·∫Øc!", "danger");
            return;
        }

        let mauSacId = hiddenInput.value;
        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√†u s·∫Øc n√†y kh√¥ng?")) {
            fetch(`/api/mau-sac/delete/${mauSacId}`, {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'}
            })
                .then(response => {
                    if (!response.ok) throw new Error("X√≥a th·∫•t b·∫°i!");
                    return response.text();
                })
                .then(message => {
                    showToast(message, "success");
                    setTimeout(() => row.remove(), 1500);
                })
                .catch(error => showToast(error.message, "danger"));
        }
    }

</script>


<!--Load table-->
<script>
    $(document).ready(function () {
        $('#productTable').DataTable({
            "paging": true,
            "lengthMenu": [5, 10, 20],
            "pageLength": 5,
            "autoWidth": false,
            "responsive": true,
            "language": {
                "sProcessing": "ƒêang x·ª≠ l√Ω...",
                "sLengthMenu": "Hi·ªÉn th·ªã _MENU_ d√≤ng",
                "sZeroRecords": "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu",
                "sInfo": "Hi·ªÉn th·ªã _START_ ƒë·∫øn _END_ trong t·ªïng _TOTAL_ d√≤ng",
                "sInfoEmpty": "Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã",
                "sInfoFiltered": "(l·ªçc t·ª´ _MAX_ d√≤ng)",
                "sSearch": "T√¨m ki·∫øm:",
                "oPaginate": {
                    "sFirst": "ƒê·∫ßu",
                    "sPrevious": "Tr∆∞·ªõc",
                    "sNext": "Ti·∫øp",
                    "sLast": "Cu·ªëi"
                }
            }
        });
    });
</script>
</body>
</html>
