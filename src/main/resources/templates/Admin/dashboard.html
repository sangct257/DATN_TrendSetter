<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/fragments/head :: head}"></head>
<style>
    .suggestions-list {
        position: absolute;
        background-color: #fff;
        border: 1px solid #ccc;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }

    .suggestions-list div {
        padding: 10px;
        cursor: pointer;
    }

    .suggestions-list div:hover {
        background-color: #f0f0f0;
    }

</style>
<body class="hold-transition skin-blue sidebar-mini">
<!-- Site wrapper -->
<div class="wrapper">

    <div th:replace="~{admin/fragments/header :: header}"></div>
    <!-- =============================================== -->

    <!-- Left side column. contains the sidebar -->
    <div th:replace="~{admin/fragments/sidebar :: sidebar}"></div>

    <!-- =============================================== -->

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                Bán Hàng Tại Quầy
                <small>it all starts here</small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="#"><i class="fa fa-dashboard"></i><a href="/admin">Home</a></a></li>
                <li><a href="#">Bán Hàng Tại Quầy</a></li>
            </ol>
            <!-- Toast Notification -->
            <div class="toast-container position-fixed top-0 end-0 p-3">
                <div th:if="${successMessage}" class="toast align-items-center text-bg-success border-0" role="alert"
                     aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <span th:text="${successMessage}"></span>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                                aria-label="Close"></button>
                    </div>
                </div>
                <div th:if="${errorMessage}" class="toast align-items-center text-bg-danger border-0" role="alert"
                     aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <span th:text="${errorMessage}"></span>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                                aria-label="Close"></button>
                    </div>
                </div>
            </div>

        </section>

        <!-- Main content -->
        <section class="content">

            <!-- Default box -->
            <div class="box">
                <div class="box-body">
                    <!--Form giao diện-->
                    <div class="container mt-5" style=" border: 2px solid ; padding: 20px; margin-top: 20px;">
                        <!-- Phần tiêu đề -->
                        <div class="mb-4 border-bottom pb-3">
                            <form th:action="@{/create-hoa-don}" method="post"
                                  class="d-flex justify-content-between align-items-center">
                                <h5 class="text-primary">
                                    <i class="fas fa-file-invoice"></i> Danh sách Hóa Đơn
                                </h5>
                                <button class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Tạo hóa đơn
                                </button>
                            </form>
                        </div>

                        <!-- Danh sách hóa đơn -->
                        <div class="row g-4">
                            <th:block th:each="hoaDon, status : ${hoaDons}">
                                <div class="col-12 col-sm-6 col-lg-4">
                                    <div class="card border-primary shadow-sm position-relative rounded-3 overflow-hidden">

                                        <!-- Nút xóa hóa đơn -->
                                        <form th:action="@{/delete/{id}(id=${hoaDon.id})}" method="POST"
                                              class="position-absolute top-0 end-0 m-2">
                                            <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                            <button type="submit"
                                                    class="btn btn-sm btn-danger d-flex align-items-center justify-content-center p-0"
                                                    style="width: 30px; height: 30px; border-radius: 50%;"
                                                    title="Xóa hóa đơn"
                                                    onclick="return confirm('Bạn có chắc chắn muốn xóa hóa đơn này?')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>

                                        <!-- Nội dung hóa đơn -->
                                        <form th:action="@{/admin/sell-counter}" method="GET" class="w-100">
                                            <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                            <button type="submit" class="btn p-0 w-100 text-start">
                                                <div class="card-header bg-primary text-white text-center py-3">
                                                    <h6 class="mb-0 text-uppercase"># <span
                                                            th:text="${hoaDon.maHoaDon}"></span></h6>
                                                </div>
                                                <div class="card-body text-center">
                                                    <p class="card-text text-muted">
                                                        <i class="fas fa-shopping-cart"></i> Số lượng sản phẩm:
                                                        <strong th:text="${hoaDon.tongSanPham}"></strong>
                                                    </p>
                                                </div>
                                                <div class="card-footer bg-light text-center">
                                                    <small class="text-muted">Chi tiết hóa đơn</small>
                                                </div>
                                            </button>
                                        </form>

                                    </div>
                                </div>
                            </th:block>
                        </div>
                    </div>
                </div>

                <div th:if="${hoaDon != null and hoaDon.id != null}">
                    <!-- Phần Sản Phẩm: -->
                    <div id="productSection" style=" border: 2px solid; padding: 20px; margin-top: 20px;">
                        <!-- Chức năng -->
                        <div class="bill-header d-flex justify-content-between align-items-center"
                             style="border-bottom: 2px solid #17a2b8; padding-bottom: 10px;">
                            <strong><i class="fas fa-list" style="color: #17a2b8; font-size: 18px;"></i> Danh Sách Sản
                                Phẩm</strong>
                            <div class="d-flex gap-2">
                                <!-- Nút QR và Thêm sản phẩm -->
                                <button class="btn btn-outline-primary">
                                    <i class="fas fa-qrcode"></i> QR Code
                                </button>
                                <a class="btn btn-outline-primary"
                                   th:href="@{/admin/add-product-modal(hoaDonId=${hoaDon.id})}">
                                    <i class="fas fa-cart-plus"></i> Thêm sản phẩm
                                </a>
                            </div>
                        </div>

                        <!-- Hiển thị danh sách sản phẩm trong giỏ hàng -->
                        <div class="product-list" style="border-top: 2px solid ; padding-top: 20px;">
                            <table class="table table-bordered table-striped align-middle">
                                <thead class="text-center">
                                <tr>
                                    <th>STT</th>
                                    <th>Sản Phẩm</th>
                                    <th style="width: 10%">Số Lượng</th>
                                    <th>Thương Hiệu</th>
                                    <th>Xuất Sứ</th>
                                    <th>Thành Tiền</th>
                                    <th>Trạng Thái</th>
                                    <th>Chọn</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:block th:each="hoaDonChiTiet, status : ${hoaDonChiTiet}">
                                    <td class="text-center" th:text="${status.index + 1}"></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img th:src="@{'/images/' + ${hoaDonChiTiet.sanPhamChiTiet.hinhAnh[0].urlHinhAnh}}"
                                                 width="80">
                                            <div class="ms-3">
                                                <strong th:text="${hoaDonChiTiet.sanPhamChiTiet.sanPham.tenSanPham}"></strong><br>
                                                <small th:text="'Màu Sắc: ' + ${hoaDonChiTiet.sanPhamChiTiet.mauSac.tenMauSac}"></small><br>
                                                <small th:text="'Size: ' + ${hoaDonChiTiet.sanPhamChiTiet.kichThuoc.tenKichThuoc}"></small><br>
                                                <small class="text-danger font-weight-bold fs-5"
                                                       th:text="${#numbers.formatInteger(hoaDonChiTiet.sanPhamChiTiet.gia, 3, 'COMMA') + ' VND'}"></small><br>
                                                <small class="text-muted"
                                                       th:text="'Tồn Kho: ' + ${hoaDonChiTiet.sanPhamChiTiet.soLuong}"></small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <form th:action="@{/update-product-order}" method="post">
                                            <input type="hidden" name="hoaDonChiTietId" th:value="${hoaDonChiTiet.id}">
                                            <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                            <input type="number" name="soLuong" th:value="${hoaDonChiTiet.soLuong}"
                                                   min="1"
                                                   class="form-control" required onchange="this.form.submit()">
                                        </form>
                                    </td>
                                    <td class="text-center"
                                        th:text="${hoaDonChiTiet.sanPhamChiTiet.sanPham.thuongHieu.tenThuongHieu}"></td>
                                    <td class="text-center"
                                        th:text="${hoaDonChiTiet.sanPhamChiTiet.sanPham.xuatXu.quocGia}"></td>
                                    <td class="text-center" th:text="${hoaDonChiTiet.thanhTien}"></td>
                                    <td class="text-center">
                        <span th:class="${hoaDonChiTiet.sanPhamChiTiet.trangThai == 'Đang Hoạt Động' ? 'badge bg-danger' : 'badge bg-success'}"
                              th:text="${hoaDonChiTiet.sanPhamChiTiet.trangThai}"></span>
                                    </td>
                                    <td>
                                        <form th:action="@{/delete-product-order}" method="post">
                                            <input type="hidden" name="hoaDonChiTietId" th:value="${hoaDonChiTiet.id}">
                                            <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                            <button type="submit" class="btn btn-danger">
                                                <i class="fas fa-trash"></i> Xóa
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <h3 th:block th:each="hoaDon : ${hoaDon}" class="text-end">
                                <strong>Tổng Tiền: </strong>
                                <small class="text-danger font-weight-bold fs-5"
                                       th:text="${(hoaDon == null or hoaDon.tongTien == null or hoaDon.tongTien == 0) ? '0 VND' : #numbers.formatInteger(hoaDon.tongTien, 3, 'COMMA') + ' VND'}">
                                </small>

                            </h3>
                        </div>
                    </div>

                    <!-- Phần Tài Khoản Khách Hàng -->
                    <div class="bill-footer" style="border: 2px solid; padding: 20px; margin-top: 20px;">
                        <div class="d-flex justify-content-between align-items-center lg">
                            <h3><i class="fas fa-user-circle" style="font-size: 24px;"></i> Tài khoản</h3>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#customerModal">
                                <i class="fas fa-user"></i> Chọn tài khoản
                            </button>

                            <!-- Modal Chọn Khách Hàng -->
                            <div class="modal fade" id="customerModal" tabindex="-1"
                                 aria-labelledby="customerModalLabel"
                                 aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="customerModalLabel">Danh sách khách hàng</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <!-- Thanh tìm kiếm và nút thêm khách hàng -->
                                            <div class="d-flex justify-content-between mb-3">
                                                <!-- Thanh tìm kiếm -->
                                                <input type="text" class="form-control me-3" id="searchCustomer"
                                                       placeholder="Tìm kiếm khách hàng...">

                                                <!-- Nút thêm khách hàng với icon -->
                                                <button type="button" class="btn btn-success" data-bs-toggle="modal"
                                                        data-bs-target="#addCustomerModal">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>

                                            <!-- Bảng danh sách khách hàng -->
                                            <table class="table">
                                                <thead>
                                                <tr>
                                                    <th>STT</th>
                                                    <th>Tên Khách Hàng</th>
                                                    <th>Số Điện Thoại</th>
                                                    <th>Email</th>
                                                    <th>Chọn</th>
                                                </tr>
                                                </thead>
                                                <tbody id="customerTableBody">
                                                <tr th:each="khachHang,status : ${khachHangs}">
                                                    <td th:text="${status.index + 1}"></td>
                                                    <td th:text="${khachHang.hoTen}"></td>
                                                    <td th:text="${khachHang.soDienThoai}"></td>
                                                    <td th:text="${khachHang.email}"></td>
                                                    <td>
                                                        <form th:action="@{/add-customer}" method="post">
                                                            <input type="hidden" name="hoaDonId"
                                                                   th:value="${hoaDon.id}">
                                                            <input type="hidden" name="khachHangId"
                                                                   th:value="${khachHang.id}">
                                                            <button type="submit" class="btn btn-primary">Chọn</button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Modal thêm khách hàng mới -->
                            <div class="modal fade" id="addCustomerModal" tabindex="-1"
                                 aria-labelledby="addCustomerModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="addCustomerModalLabel">Thêm Khách Hàng Mới</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form th:action="@{/add-new-customer}" method="post" id="addCustomerForm">
                                                <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                                <div class="mb-3">
                                                    <label for="nguoiNhan" class="form-label">Họ Tên</label>
                                                    <input type="text" class="form-control" id="nguoiNhan"
                                                           name="nguoiNhan" placeholder="Nhập họ tên" required>
                                                    <span class="text-danger" id="nguoiNhanError"></span>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="soDienThoai" class="form-label">Số Điện Thoại</label>
                                                    <input type="text" class="form-control" id="soDienThoai"
                                                           name="soDienThoai" placeholder="Nhập số điện thoại" required>
                                                    <span class="text-danger" id="soDienThoaiError"></span>
                                                </div>

                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">
                                                        Hủy
                                                    </button>
                                                    <button type="submit" class="btn btn-primary">Lưu</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-center my-2">
                            <div class="p-4 rounded border bg-light w-100">
                                <!-- Kiểm tra xem có ít nhất 1 thông tin khách hàng -->
                                <div th:if="${hoaDon.nguoiNhan != null || hoaDon.soDienThoai != null || hoaDon.email != null}">
                                    <!-- Tên Khách Hàng -->
                                    <div class="row mb-3">
                                        <div class="col-md-6 fw-bold">Tên Khách Hàng:</div>
                                        <span class="col-md-6 fw-semibold"
                                              th:text="${hoaDon.nguoiNhan != null ? hoaDon.nguoiNhan : '(Không có tên)'}"></span>
                                    </div>

                                    <!-- Số Điện Thoại -->
                                    <div class="row mb-3">
                                        <div class="col-md-6 fw-bold">Số Điện Thoại:</div>
                                        <span class="col-md-6 text-muted"
                                              th:text="${hoaDon.soDienThoai != null ? hoaDon.soDienThoai : '(Không có số điện thoại)'}"></span>
                                    </div>

                                    <!-- Email -->
                                    <div class="row mb-3">
                                        <div class="col-md-6 fw-bold">Email:</div>
                                        <span class="col-md-6 text-muted"
                                              th:text="${hoaDon.email != null ? hoaDon.email : '(Không có email)'}"></span>
                                    </div>
                                </div>

                                <!-- Nếu không có thông tin khách hàng -->
                                <div th:if="${hoaDon.nguoiNhan == null && hoaDon.soDienThoai == null && hoaDon.email == null}"
                                     class="row">
                                    <div class="col-md-12 text-danger fw-bold">Khách Lẻ</div>
                                </div>
                            </div>

                            <!-- Nút xóa khách hàng (Chỉ hiển thị nếu hoaDon.khachHang != null) -->
                            <form th:if="${hoaDon.nguoiNhan != null && hoaDon.soDienThoai != null}"
                                  th:action="@{/delete-customer}" method="post"
                                  class="d-inline w-100"
                                  onsubmit="return confirm('Bạn có chắc chắn muốn xóa khách hàng này?')">
                                <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                <button type="submit" class="btn btn-link text-danger p-0 ms-2" title="Xóa khách hàng">
                                    <i class="fas fa-times"></i>
                                </button>
                            </form>
                        </div>

                    </div>

                    <!-- Phần Thanh Toán -->
                    <div class="payment-section" style="border: 2px solid; padding: 20px; margin-top: 20px;">
                        <div class="row">
                            <!-- Cột thông tin giao hàng bên trái -->
                            <div class="col-md-6">
                                <h3><i class="fas fa-shipping-fast" style="font-size: 24px;"></i> Thông tin giao hàng
                                </h3>

                                <div class="mt-3" id="shippingForm" style="display: none;">
                                    <div class="card card-body">
                                        <form th:action="@{/update-shipping}" method="post">
                                            <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                            <div class="row">
                                                <div class="col-md-12 mb-3">
                                                    <input type="text" name="nguoiNhan" class="form-control w-100"
                                                           id="shippingNguoiNhan"
                                                           th:value="${hoaDon.nguoiNhan != null ? hoaDon.nguoiNhan : '(Không có tên khách hàng)'}"
                                                           th:disabled="${hoaDon.khachHang == null}">
                                                    <span class="text-danger" id="shippingNguoiNhanError"></span>
                                                </div>

                                                <div class="col-md-12 mb-3">
                                                    <input type="text" name="soDienThoai" class="form-control w-100"
                                                           id="shippingSoDienThoai"
                                                           th:value="${hoaDon.soDienThoai != null ? hoaDon.soDienThoai : '(Không có số điện thoại)'}"
                                                           th:disabled="${hoaDon.khachHang == null}">
                                                    <span class="text-danger" id="shippingSoDienThoaiError"></span>
                                                </div>

                                                <div class="col-md-12 mb-3">
                                                    <input type="text" name="email" class="form-control w-100"
                                                           id="shippingEmail"
                                                           th:value="${hoaDon.email != null ? hoaDon.email : '(Không có email)'}"
                                                           th:disabled="${hoaDon.email == null}">
                                                    <span class="text-danger" id="shippingEmailError"></span>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <input type="text" id="soNha" name="soNha" class="form-control"
                                                               th:value="${hoaDon.soNha}" placeholder="Số nhà">
                                                        <span class="text-danger" id="soNhaError"></span>
                                                    </div>

                                                    <div class="col-md-6 mb-3">
                                                        <input type="text" id="tenDuong" name="tenDuong"
                                                               class="form-control" th:value="${hoaDon.tenDuong}"
                                                               placeholder="Tên đường">
                                                        <span class="text-danger" id="tenDuongError"></span>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-4 mb-3">
                                                        <select id="thanhPho" name="thanhPho" class="form-control">
                                                            <option th:value="${hoaDon.thanhPho}" th:text="${hoaDon.thanhPho != null ? hoaDon.thanhPho : 'Chọn Tỉnh/Thành phố'}"></option>
                                                        </select>
                                                        <input type="hidden" id="thanhPhoHidden" name="thanhPhoHidden" th:value="${hoaDon.thanhPho}">

                                                        <span class="text-danger" id="thanhPhoError"></span>
                                                    </div>

                                                    <div class="col-md-4 mb-3">
                                                        <select id="huyen" name="huyen" class="form-control">
                                                            <option th:value="${hoaDon.huyen}" th:text="${hoaDon.huyen != null ? hoaDon.huyen : 'Chọn Quận/Huyện'}"></option>
                                                        </select>
                                                        <input type="hidden" id="huyenHidden" name="huyenHidden" th:value="${hoaDon.huyen}">
                                                        <span class="text-danger" id="huyenError"></span>
                                                    </div>

                                                    <div class="col-md-4 mb-3">
                                                        <select id="phuong" name="phuong" class="form-control">
                                                            <option th:value="${hoaDon.phuong}" th:text="${hoaDon.phuong != null ? hoaDon.phuong : 'Chọn Phường/Xã'}"></option>
                                                        </select>
                                                        <input type="hidden" id="phuongHidden" name="phuongHidden" th:value="${hoaDon.phuong}">
                                                        <span class="text-danger" id="phuongError"></span>
                                                    </div>

                                                </div>

                                                <div class="form-group">
                                                    <textarea id="ghiChu" placeholder="Nhập ghi chú nếu có"
                                                              name="ghiChu" class="form-control" rows="3"></textarea>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-primary w-100">Cập nhật giao hàng
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Cột thông tin thanh toán bên phải -->
                            <div class="col-md-6">
                                <h3><i class="fas fa-wallet"></i> Thông tin thanh toán</h3>

                                <!-- Phương thức thanh toán -->
                                <div class="d-flex align-items-center mb-4">
    <span>
        <i class="fas fa-credit-card"></i>
        <strong>Phương thức thanh toán: </strong>
        <span id="paymentMethodText"
              th:text="${hoaDon.phuongThucThanhToan != null ? hoaDon.phuongThucThanhToan.tenPhuongThuc : 'Chưa có phương thức'}"></span>
    </span>

                                    <!-- Mở modal -->
                                    <button type="button" class="btn btn-outline-primary ms-auto" data-bs-toggle="modal"
                                            data-bs-target="#paymentModal">
                                        <i class="bi bi-credit-card"></i>
                                    </button>
                                </div>

                                <!-- Modal chọn phương thức thanh toán -->
                                <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="paymentModalLabel">Chọn phương thức thanh toán</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="paymentMethodForm">
                                                    <input type="hidden" name="hoaDonId" th:value="${hoaDon != null ? hoaDon.id : ''}">

                                                    <div class="mb-3">
                                                        <label class="form-label"><i class="fas fa-credit-card"></i> Phương thức thanh toán:</label>
                                                        <div class="btn-group w-100" role="group" aria-label="Chọn phương thức thanh toán">
                                                            <th:block th:each="phuongThucThanhToan : ${listPhuongThucThanhToan}">
                                                                <input type="hidden" id="phiShip" th:value="${hoaDon.phiShip}">
                                                                <input type="hidden" id="listPhieuGiamGia" th:value="${hoaDon.phieuGiamGia != null ? hoaDon.phieuGiamGia.giaTri : 0}">
                                                                <input type="radio" class="btn-check" name="phuongThucThanhToanId" th:id="'payment-' + ${phuongThucThanhToan.id}" th:value="${phuongThucThanhToan.id}" autocomplete="off">
                                                                <label class="btn btn-outline-primary" th:for="'payment-' + ${phuongThucThanhToan.id}" th:text="${phuongThucThanhToan.tenPhuongThuc}"></label>
                                                            </th:block>
                                                        </div>
                                                    </div>


                                                    <!-- Form nhập số tiền (chỉ hiển thị nếu chọn Tiền Mặt) -->
                                                    <div id="paymentDetails">
                                                        <!-- Nội dung động sẽ hiển thị ở đây -->
                                                    </div>

                                                    <button type="button" id="addPaymentMethodButton" class="btn btn-primary">
                                                        Cập nhật
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <!-- Mã Giảm Giá -->
                                <div class="d-flex align-items-center mb-4">
                                    <span>
                                        <i class="fas fa-tag"></i>
                                        <strong>Mã giảm giá: </strong>
                                        <span th:text="${hoaDon.phieuGiamGia != null ? hoaDon.phieuGiamGia.tenChuongTrinh : 'Chưa có phiếu giảm giá'}"></span>
                                    </span>

                                    <!-- Mở modal chọn mã giảm giá -->
                                    <button type="button" class="btn btn-outline-primary ms-auto" data-bs-toggle="modal"
                                            data-bs-target="#discountModal">
                                        <i class="fas fa-tag"></i>
                                    </button>

                                    <!-- Modal mã giảm giá -->
                                    <div class="modal fade" id="discountModal" tabindex="-1"
                                         aria-labelledby="discountModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="discountModalLabel">Chọn mã giảm
                                                        giá</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <form th:action="@{/apply-phieu-giam-gia}" method="post">
                                                        <input type="hidden" name="hoaDonId"
                                                               th:value="${hoaDon != null ? hoaDon.id : ''}">
                                                        <div class="mb-3">
                                                            <label for="tenChuongTrinh" class="form-label">
                                                                <i class="fas fa-tag"></i> Mã giảm giá:
                                                            </label>
                                                            <select id="tenChuongTrinh" name="tenChuongTrinh"
                                                                    class="form-select">
                                                                <option value="null" disabled selected>Chọn phiếu giảm
                                                                    giá
                                                                </option>
                                                                <th:block th:each="phieuGiamGia : ${listPhieuGiamGia}">
                                                                    <option th:value="${phieuGiamGia.tenChuongTrinh}"
                                                                            th:text="${phieuGiamGia.tenChuongTrinh + ' ( ' + #numbers.formatInteger(phieuGiamGia.giaTri, 3, 'COMMA') + ' ' + 'VND' + ' ) ' }"></option>
                                                                </th:block>
                                                            </select>
                                                        </div>
                                                        <button type="submit" class="btn btn-primary">Áp dụng</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Giao Hàng -->
                                <div class="info mb-4 d-flex align-items-center">
                                    <i class="fas fa-truck me-2"></i>
                                    <span class="me-auto fw-bold">Giao Hàng:</span>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="deliverySwitch"
                                               th:data-hoa-don-id="${hoaDon.id}"
                                               th:checked="${hoaDon.loaiHoaDon == 'Giao Hàng'}"
                                               onchange="preventUncheck(this)">

                                    </div>
                                </div>

                                <!-- Phí Ship -->
                                <div class="info mb-4">
                                    <span><i class="fas fa-box"></i> Phí Ship:</span>
                                    <span th:text="${hoaDon.phiShip != 0 ? #numbers.formatInteger(hoaDon.phiShip, 3, 'COMMA') + ' VND' : '0 VND'}"></span>
                                </div>

                                <!-- Tiền hàng -->
                                <div class="info mb-4">
                                    <span><i class="fas fa-box"></i> Tiền hàng:</span>
                                    <span th:text="${(hoaDon.tongTien != null && hoaDon.tongTien != 0) ?
                                    #numbers.formatInteger(hoaDon.tongTien, 3, 'COMMA') + ' VNĐ'
                                    : '0 VND'}"></span>
                                </div>

                                <!-- Giảm Giá -->
                                <div class="info mb-4">
                                    <span><i class="fas fa-percent"></i> Giảm giá:</span>
                                    <span th:text="${hoaDon.phieuGiamGia != null ? hoaDon.phieuGiamGia.giaTri + ' VNĐ' : '0 VNĐ'}"></span>
                                </div>

                                <!-- Tổng Tiền -->
                                <div class="info mb-3"><br>
                                    <!-- Tổng Tiền -->
                                    <div class="info mb-3">
                                        <strong>Tổng tiền:</strong>
                                        <strong>
                                            <span th:text="${(hoaDon.tongTien != null && hoaDon.tongTien != 0) ?
                                                    #numbers.formatInteger(hoaDon.tongTien - (hoaDon.phieuGiamGia != null ? hoaDon.phieuGiamGia.giaTri : 0) + hoaDon.phiShip, 3, 'COMMA') + ' VNĐ'
                                                    : '0 VNĐ'}"></span>
                                            <span data-bs-toggle="modal" data-bs-target="#infoModal">
                                                <i class="bi bi-question-circle"></i>
                                            </span>
                                        </strong>
                                    </div>

                                    <!-- Modal -->
                                    <div class="modal fade" id="infoModal" tabindex="-1"
                                         aria-labelledby="infoModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="infoModalLabel">Cách tính Tổng tiền</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p>Công thức tính tổng tiền là:</p>
                                                    <ul>
                                                        <li><strong>Tổng tiền hóa đơn</strong> - <strong>Giá trị phiếu
                                                            giảm giá</strong> + <strong>Phí vận chuyển</strong></li>
                                                        <span th:text="${(hoaDon.tongTien != null && hoaDon.tongTien != 0) ?
                                                    #numbers.formatInteger(hoaDon.tongTien - (hoaDon.phieuGiamGia != null ? hoaDon.phieuGiamGia.giaTri : 0) + hoaDon.phiShip, 3, 'COMMA') + ' VNĐ'
                                                    : '0 VNĐ'}"></span>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Xác Nhận Thanh Toán -->
                                <!-- Nút mở modal -->
                                <div class="confirm-button mt-3">
                                    <br>
                                    <form id="paymentForm" th:action="@{/confirm-payment}" method="POST">
                                        <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                        <button type="button" class="btn btn-success w-100" data-bs-toggle="modal"
                                                data-bs-target="#confirmModal">
                                            <i class="fas fa-check-circle"></i> Xác nhận thanh toán
                                        </button>
                                    </form>
                                </div>

                                <!-- Modal -->
                                <div class="modal fade" id="confirmModal" tabindex="-1"
                                     aria-labelledby="confirmModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="confirmModalLabel">Xác nhận thanh toán</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                <span th:text="${hoaDon.loaiHoaDon == 'Tại Quầy' ? 'Bạn có muốn xác nhận thanh toán hóa đơn tại quầy không?'
                                    : 'Bạn có muốn xác nhận thanh toán hóa đơn giao hàng không?'}"></span>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Hủy
                                                </button>
                                                <button type="button" class="btn btn-success" id="confirmPayment">Xác
                                                    nhận
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- /.box -->

        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <div th:replace="~{admin/fragments/footer :: footer}"></div>


</div>
<!-- ./wrapper -->

<!-- jQuery 3 -->

<div th:replace="~{admin/fragments/script :: script}"></div>
<!-- Thêm đoạn mã để kích hoạt tooltip -->
<script >
    document.addEventListener("DOMContentLoaded", function () {
        var successMessage = /*[[${successMessage}]]*/ null;
        var errorMessage = /*[[${errorMessage}]]*/ null;

        if (successMessage) {
            let toastSuccessEl = document.querySelector('.toast.text-bg-success');
            if (toastSuccessEl) {
                let toastSuccess = new bootstrap.Toast(toastSuccessEl, {delay: 10000});
                toastSuccess.show();
            }
        }

        if (errorMessage) {
            let toastErrorEl = document.querySelector('.toast.text-bg-danger');
            if (toastErrorEl) {
                let toastError = new bootstrap.Toast(toastErrorEl, {delay: 10000});
                toastError.show();
            }
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        const deliverySwitch = document.getElementById("deliverySwitch");
        const shippingForm = document.getElementById("shippingForm");

        function toggleShippingForm() {
            if (deliverySwitch.checked) {
                shippingForm.style.display = "block";
            } else {
                shippingForm.style.display = "none";
            }
        }

        // Gọi hàm ngay khi trang tải để kiểm tra trạng thái ban đầu
        toggleShippingForm();

        // Bật/tắt form khi checkbox thay đổi
        deliverySwitch.addEventListener("change", toggleShippingForm);
    });

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("confirmPayment").addEventListener("click", function () {
            document.getElementById("paymentForm").submit(); // Submit form khi nhấn xác nhận
        });
    });

    function preventUncheck(checkbox) {
        const hoaDonId = checkbox.getAttribute("data-hoa-don-id");

        if (!hoaDonId || isNaN(hoaDonId)) {
            console.error("Lỗi: hoaDonId không hợp lệ:", hoaDonId);
            return;
        }

        fetch(`/api/hoa-don/toggle-delivery/${hoaDonId}?delivery=${checkbox.checked}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.successMessage) {
                    showToast(data.successMessage, "success");
                } else if (data.errorMessage) {
                    showToast(data.errorMessage, "error");
                }
            })
            .catch(error => console.error('Lỗi API:', error.message));
    }

    // Hiển thị Toast Notification
    function showToast(message, type) {
        const toastContainer = document.querySelector(".toast-container");
        const toast = document.createElement("div");
        toast.className = `toast align-items-center text-bg-${type === "success" ? "success" : "danger"} border-0`;
        toast.role = "alert";
        toast.ariaLive = "assertive";
        toast.ariaAtomic = "true";
        toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    `;
        toastContainer.appendChild(toast);

        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        // Xóa toast sau khi 5s
        setTimeout(() => toast.remove(), 5000);
    }

</script>

<!--Phuong thuc thanh toan-->
<script>
    $(document).ready(function () {
        let paymentOptions = $("input[name='phuongThucThanhToanId']");
        let paymentDetails = $("#paymentDetails");
        let paymentMethodText = $("#paymentMethodText");

        // Lấy tổng tiền hóa đơn từ Thymeleaf
        let tongTienHoaDon = parseFloat('[[${hoaDon != null ? hoaDon.tongTien : 0}]]');

        // Xử lý khi chọn phương thức thanh toán
        paymentOptions.change(function () {
            let selectedText = $("label[for='" + this.id + "']").text().trim();
            paymentDetails.html(""); // Xóa nội dung cũ

            if (selectedText === "Tiền Mặt") {
                paymentDetails.html(`
                <div class="mb-3">
                    <label for="cashAmount" class="form-label"><i class="fas fa-money-bill-wave"></i> Nhập số tiền khách đưa:</label>
                    <input type="number" id="cashAmount" name="cashAmount" class="form-control" placeholder="Nhập số tiền khách đưa" min="0">
                </div>
                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-coins"></i> Số tiền thối lại:</label>
                    <input type="text" id="changeAmount" class="form-control" readonly>
                </div>
            `);

                let cashInput = $("#cashAmount");
                let changeOutput = $("#changeAmount");

                cashInput.on("input", function () {
                    let cashGiven = parseFloat($(this).val()) || 0;
                    let phiShip = parseFloat($("#phiShip").val()) || 0;
                    let maGiamGia = parseFloat($("#listPhieuGiamGia").val()) || 0;
                    let totalAmount = tongTienHoaDon + phiShip - maGiamGia;

                    let change = cashGiven - totalAmount;

                    if (change < 0) {
                        changeOutput.val(`Thiếu ${Math.abs(change).toLocaleString()} VND`).css("color", "red");
                    } else {
                        changeOutput.val(`${change.toLocaleString()} VND`).css("color", "green");
                    }
                });


            } else if (selectedText === "Chuyển Khoản") {
                paymentDetails.html(`
                <div class="mb-3 text-center">
                    <img id="qrCodeImage" src="http://localhost:8080/images/path-to-qr-code.jpg" alt="QR Code" class="img-fluid" style="max-width: 250px;">
                </div>
            `);
            }
        });

        // Xử lý khi nhấn nút "Cập nhật" để chọn phương thức thanh toán
        $("#addPaymentMethodButton").click(function () {
            var formData = $("#paymentMethodForm").serialize(); // Lấy toàn bộ dữ liệu form
            var selectedPayment = $("input[name='phuongThucThanhToanId']:checked").val(); // Lấy giá trị chọn

            if (!selectedPayment) {
                alert("Vui lòng chọn phương thức thanh toán!");
                return;
            }

            $.ajax({
                url: '/add-payment-method',
                method: 'POST',
                data: formData,
                success: function (response) {
                    if (response.success) {
                        paymentMethodText.text(response.updatedPaymentMethod); // Cập nhật UI
                        $("#paymentModal").modal("hide"); // Đóng modal
                    } else {
                        alert(response.message || "Cập nhật không thành công!");
                    }
                },
                error: function (xhr) {
                    alert("Lỗi: " + xhr.responseText);
                }
            });
        });
    });
</script>

<!--validate-->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("addCustomerForm").addEventListener("submit", function (event) {
            let isValid = true;

            // Lấy giá trị input
            let nguoiNhan = document.getElementById("nguoiNhan").value.trim();
            let soDienThoai = document.getElementById("soDienThoai").value.trim();

            // Xóa thông báo lỗi cũ
            document.getElementById("nguoiNhanError").innerText = "";
            document.getElementById("soDienThoaiError").innerText = "";

            // Kiểm tra họ tên (phải có ít nhất 2 từ)
            if (nguoiNhan === "") {
                document.getElementById("nguoiNhanError").innerText = "Họ tên không được để trống.";
                isValid = false;
            } else if (!/^[A-Za-zÀ-ỹ\s]+$/.test(nguoiNhan)) {
                document.getElementById("nguoiNhanError").innerText = "Họ tên chỉ được chứa chữ cái.";
                isValid = false;
            } else if (!/^\S+\s+\S+/.test(nguoiNhan)) {
                document.getElementById("nguoiNhanError").innerText = "Vui lòng nhập đầy đủ họ và tên.";
                isValid = false;
            }

            // Kiểm tra số điện thoại (10-11 chữ số)
            if (!/^\d{10,11}$/.test(soDienThoai)) {
                document.getElementById("soDienThoaiError").innerText = "Số điện thoại phải từ 10-11 số.";
                isValid = false;
            }

            // Nếu có lỗi, ngăn form submit
            if (!isValid) {
                event.preventDefault();
            }
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const thanhPhoSelect = document.getElementById("thanhPho");
        const huyenSelect = document.getElementById("huyen");
        const phuongSelect = document.getElementById("phuong");

        const thanhPhoHidden = document.getElementById("thanhPhoHidden");
        const huyenHidden = document.getElementById("huyenHidden");
        const phuongHidden = document.getElementById("phuongHidden");

        // Hàm fetch tỉnh/thành phố
        function fetchProvinces(selectedValue = "") {
            fetch("/api/ghn/provinces")
                .then(response => response.json())
                .then(data => {
                    thanhPhoSelect.innerHTML = '<option value="">Chọn Tỉnh/Thành phố</option>';
                    let selectedProvinceId = "";

                    data.data.forEach(province => {
                        const selected = province.ProvinceName === selectedValue ? "selected" : "";
                        if (selected) selectedProvinceId = province.ProvinceID;
                        thanhPhoSelect.innerHTML += `<option value="${province.ProvinceName}" data-id="${province.ProvinceID}" ${selected}>${province.ProvinceName}</option>`;
                    });

                    if (selectedProvinceId) fetchDistricts(selectedProvinceId, huyenHidden.value);
                })
                .catch(error => console.error("Lỗi khi lấy danh sách tỉnh/thành phố:", error));
        }

        // Hàm fetch quận/huyện
        function fetchDistricts(provinceId, selectedValue = "") {
            fetch(`/api/ghn/districts?province_id=${provinceId}`)
                .then(response => response.json())
                .then(data => {
                    huyenSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
                    let selectedDistrictId = "";

                    data.data.forEach(district => {
                        const selected = district.DistrictName === selectedValue ? "selected" : "";
                        if (selected) selectedDistrictId = district.DistrictID;
                        huyenSelect.innerHTML += `<option value="${district.DistrictName}" data-id="${district.DistrictID}" ${selected}>${district.DistrictName}</option>`;
                    });

                    if (selectedDistrictId) fetchWards(selectedDistrictId, phuongHidden.value);
                })
                .catch(error => console.error("Lỗi khi lấy danh sách quận/huyện:", error));
        }

        // Hàm fetch phường/xã
        function fetchWards(districtId, selectedValue = "") {
            fetch(`/api/ghn/wards?district_id=${districtId}`)
                .then(response => response.json())
                .then(data => {
                    phuongSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';

                    data.data.forEach(ward => {
                        const selected = ward.WardName === selectedValue ? "selected" : "";
                        phuongSelect.innerHTML += `<option value="${ward.WardName}" data-id="${ward.WardCode}" ${selected}>${ward.WardName}</option>`;
                    });
                })
                .catch(error => console.error("Lỗi khi lấy danh sách phường/xã:", error));
        }

        // Xử lý khi chọn tỉnh/thành phố
        thanhPhoSelect.addEventListener("change", function () {
            const selectedOption = this.options[this.selectedIndex];
            const provinceId = selectedOption.getAttribute("data-id");

            thanhPhoHidden.value = selectedOption.value;
            huyenHidden.value = "";
            phuongHidden.value = "";

            huyenSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
            phuongSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';

            if (provinceId) {
                fetchDistricts(provinceId);
            }
        });

        // Xử lý khi chọn quận/huyện
        huyenSelect.addEventListener("change", function () {
            const selectedOption = this.options[this.selectedIndex];
            const districtId = selectedOption.getAttribute("data-id");

            huyenHidden.value = selectedOption.value;
            phuongHidden.value = "";

            phuongSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';

            if (districtId) {
                fetchWards(districtId);
            }
        });

        // Xử lý khi chọn phường/xã
        phuongSelect.addEventListener("change", function () {
            phuongHidden.value = this.value;
        });

        // Nếu có dữ liệu cũ, hiển thị trước rồi cho phép thay đổi
        if (thanhPhoHidden.value) {
            fetchProvinces(thanhPhoHidden.value);
        } else {
            fetchProvinces();
        }
    });
</script>

</body>
</html>
