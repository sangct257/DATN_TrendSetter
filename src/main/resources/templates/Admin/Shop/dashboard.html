<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/fragments/head :: head}"></head>
<style>
    .selected-hoa-don {
        box-shadow: 0 0 10px 3px rgba(0, 123, 255, 0.7) !important; /* Vi·ªÅn s√°ng xanh */
        border: 2px solid #007bff !important; /* ƒê∆∞·ªùng vi·ªÅn xanh */
    }
</style>
<body class="hold-transition skin-blue sidebar-mini">
<!-- Site wrapper -->
<div class="wrapper">

    <div th:replace="~{admin/fragments/header :: header}"></div>
    <!-- =============================================== -->

    <!-- Left side column. contains the sidebar -->
    <div th:replace="~{admin/fragments/sidebar :: sidebar}"></div>

    <!-- =============================================== -->

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                B√°n H√†ng T·∫°i Qu·∫ßy
            </h1>
        </section>


        <!-- Main content -->
        <section class="content">

            <!-- Default box -->
            <div class="box">
                <div class="box-body">
                    <!--Form giao di·ªán-->
                    <div class="container mt-5" style=" border: 2px solid ; padding: 20px; margin-top: 20px;">
                        <!-- Ph·∫ßn ti√™u ƒë·ªÅ -->
                        <div class="mb-4 border-bottom pb-3">
                            <form id="createHoaDonForm" class="d-flex justify-content-between align-items-center">
                                <h5 class="text-primary">
                                    <i class="fas fa-file-invoice"></i> Danh s√°ch H√≥a ƒê∆°n
                                </h5>
                                <button type="button" class="btn btn-primary fw-bold shadow-lg transition-transform
                                scale-100 hover-scale-110 focus-scale-110" onclick="createHoaDon()">
                                    <i class="fas fa-plus"></i> T·∫°o h√≥a ƒë∆°n
                                </button>

                            </form>
                        </div>

                        <!-- Danh s√°ch h√≥a ƒë∆°n -->
                        <div class="row g-4">
                            <th:block th:each="hoaDon, status : ${hoaDons}">
                                <div class="col-12 col-sm-6 col-lg-4">
                                    <div class="card border-primary shadow-sm position-relative rounded-3 overflow-hidden"
                                         onclick="selectHoaDon(this)">
                                        <div class="position-absolute top-0 end-0 m-2">
                                            <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                            <button type="button" class="btn btn-sm btn-danger d-flex align-items-center justify-content-center p-0"
                                                    style="width: 30px; height: 30px; border-radius: 50%;"
                                                    title="X√≥a h√≥a ƒë∆°n"
                                                    th:attr="onclick=|confirmDeleteHoaDon(this, '${hoaDon.id}')|">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <form th:action="@{/admin/sell-counter}" method="GET" class="w-100"
                                              onsubmit="saveHoaDonId(this.querySelector('input[name=hoaDonId]').value)">
                                            <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                            <button type="submit" class="btn p-0 w-100 text-start">
                                                <div class="card-header bg-primary text-white text-center py-3">
                                                    <h6 class="mb-0 text-uppercase"># <span th:text="${hoaDon.maHoaDon}"></span></h6>
                                                </div>
                                                <div class="card-body text-center">
                                                    <p class="card-text text-muted">
                                                        <i class="fas fa-shopping-cart"></i> S·ªë l∆∞·ª£ng s·∫£n ph·∫©m:
                                                        <strong th:text="${hoaDon.tongSanPham}"></strong>
                                                    </p>
                                                </div>
                                                <div class="card-footer bg-light text-center">
                                                    <small class="text-muted">Chi ti·∫øt h√≥a ƒë∆°n</small>
                                                </div>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </th:block>
                        </div>
                    </div>
                </div>

                <div th:if="${hoaDon != null and hoaDon.id != null}">
                    <!-- Ph·∫ßn S·∫£n Ph·∫©m: -->
                    <div style=" border: 2px solid; padding: 20px; margin-top: 20px;">
                        <!-- Ch·ª©c nƒÉng -->
                        <div class="bill-header d-flex justify-content-between align-items-center"
                             style="border-bottom: 2px solid #17a2b8; padding-bottom: 10px;">
                            <strong><i class="fas fa-list" style="color: #17a2b8; font-size: 18px;"></i> Danh S√°ch S·∫£n
                                Ph·∫©m</strong>
                            <div class="d-flex gap-2">
                                <button class="btn btn-light">
                                    <a class="btn btn-light" data-bs-toggle="modal"
                                       data-bs-target="#addProductModal">
                                        <i class="fas fa-cart-plus"></i> Th√™m s·∫£n ph·∫©m
                                    </a>
                                </button>

                                <div class="modal fade" id="addProductModal" tabindex="-1"
                                     aria-labelledby="addProductModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content" style="border: 2px solid">
                                            <div class="modal-header bg-primary text-white">
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="orderForm">
                                                    <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                                    <div class="product-list"
                                                         style="border-top: 2px solid; padding-top: 20px;">
                                                        <!-- B·∫£ng s·∫£n ph·∫©m cƒÉn ch·ªânh ƒë·∫πp h∆°n -->
                                                        <div class="table-responsive">
                                                            <table id="productTable"
                                                                   class="table table-striped table-bordered">
                                                                <thead class="table-dark">
                                                                <div class="d-flex mb-3 align-items-center">
                                                                    <select id="filterKichThuoc" class="form-select">
                                                                        <option value="">-- L·ªçc theo k√≠ch th∆∞·ªõc --</option>
                                                                        <option th:each="kichThuoc : ${danhSachKichThuoc}" th:value="${kichThuoc.tenKichThuoc}" th:text="${kichThuoc.tenKichThuoc}"></option>
                                                                    </select>

                                                                    <select id="filterMauSac" class="form-select">
                                                                        <option value="">-- L·ªçc theo m√†u s·∫Øc --</option>
                                                                        <option th:each="mauSac : ${danhSachMauSac}" th:value="${mauSac.tenMauSac}" th:text="${mauSac.tenMauSac}"></option>
                                                                    </select>
                                                                </div>

                                                                <tr class="text-center">
                                                                    <th class="text-center">#</th>
                                                                    <th class="text-center">H√¨nh ·∫¢nh</th>
                                                                    <th class="text-center">Th√¥ng Tin S·∫£n Ph·∫©m</th>
                                                                    <th class="text-center">S·ªë L∆∞·ª£ng</th>
                                                                    <th class="text-center">Gi√°</th>
                                                                    <th class="text-center">Tr·∫°ng Th√°i</th>
                                                                    <th class="text-center">Ch·ªçn</th>
                                                                </tr>
                                                                </thead>
                                                                <tbody>
                                                                <tr th:each="sanPhamChiTiet, status : ${sanPhamChiTiet}"
                                                                    th:if="${sanPhamChiTiet.soLuong != null and sanPhamChiTiet.gia != null and sanPhamChiTiet.hinhAnh != null and #lists.size(sanPhamChiTiet.hinhAnh) > 0}">
                                                                    <td th:text="${sanPhamChiTiet.id}"
                                                                        class="text-center">
                                                                        <input type="hidden"
                                                                               th:value="${sanPhamChiTiet.id}">
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <img th:src="@{${sanPhamChiTiet.hinhAnh[0].urlHinhAnh}}"
                                                                             class="rounded border shadow-sm"
                                                                             style="width: 70px; height: 70px; object-fit: cover;">
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="text-primary d-inline-block"
                                                                                th:text="${sanPhamChiTiet.sanPham.tenSanPham}"></strong>
                                                                        (<span
                                                                            th:text="${sanPhamChiTiet.mauSac.tenMauSac}"></span>
                                                                        -
                                                                        <span th:text="${sanPhamChiTiet.kichThuoc.tenKichThuoc}"></span>)<br>
                                                                        <small class="text-muted"
                                                                               th:text="'T·ªìn Kho: ' + ${sanPhamChiTiet.soLuong}"></small>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="number" name="soLuong" value="1"
                                                                               min="1"
                                                                               th:max="${sanPhamChiTiet.soLuong}"
                                                                               class="form-control form-control-sm text-center">
                                                                    </td>
                                                                    <td class="fw-bold text-danger text-center">
                                                                        <span th:text="${#numbers.formatDecimal(sanPhamChiTiet.gia, 0, 'COMMA', 0, 'POINT') + ' VND'}"></span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <button th:class="${sanPhamChiTiet.trangThai == 'C√≤n H√†ng' ? 'badge bg-success' : 'badge bg-danger'}"
                                                                                th:text="${sanPhamChiTiet.trangThai}">
                                                                        </button>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <button type="button"
                                                                                class="btn btn-outline-primary btn-sm fw-bold"
                                                                                onclick="addProductOrder(this)">
                                                                            <i class="bi bi-cart-plus"></i> Ch·ªçn
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Hi·ªÉn th·ªã danh s√°ch s·∫£n ph·∫©m trong gi·ªè h√†ng -->
                        <div class="product-list" style="border-top: 2px solid ; padding-top: 20px;">
                            <table class="table table-bordered table-striped align-middle">
                                <thead class="text-center">
                                <tr>
                                    <th>STT</th>
                                    <th>S·∫£n Ph·∫©m</th>
                                    <th style="width: 10%">S·ªë L∆∞·ª£ng</th>
                                    <th>Th∆∞∆°ng Hi·ªáu</th>
                                    <th>Xu·∫•t S·ª©</th>
                                    <th>Th√†nh Ti·ªÅn</th>
                                    <th>Tr·∫°ng Th√°i</th>
                                    <th>Ch·ªçn</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:block th:each="hoaDonChiTiet, status : ${hoaDonChiTiet}">
                                    <td class="text-center" th:text="${status.index + 1}"></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img th:src="${hoaDonChiTiet.sanPhamChiTiet.hinhAnh[0].urlHinhAnh}"
                                                 width="80">
                                            <div class="ms-3">
                                                <strong th:text="${hoaDonChiTiet.sanPhamChiTiet.sanPham.tenSanPham}"></strong><br>
                                                <small th:text="'M√†u S·∫Øc: ' + ${hoaDonChiTiet.sanPhamChiTiet.mauSac.tenMauSac}"></small><br>
                                                <small th:text="'Size: ' + ${hoaDonChiTiet.sanPhamChiTiet.kichThuoc.tenKichThuoc}"></small><br>
                                                <small class="text-danger font-weight-bold fs-5"
                                                       th:text="${#numbers.formatInteger(hoaDonChiTiet.sanPhamChiTiet.gia, 3, 'COMMA') + ' VND'}"></small><br>
                                                <small class="text-muted"
                                                       th:text="'T·ªìn Kho: ' + ${hoaDonChiTiet.sanPhamChiTiet.soLuong}"></small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="number" name="soLuong" th:value="${hoaDonChiTiet.soLuong}" min="1"
                                               class="form-control" required onchange="updateQuantityOrder(this)">
                                        <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                        <input type="hidden" name="hoaDonChiTietId" th:value="${hoaDonChiTiet.id}">
                                    </td>

                                    <td class="text-center"
                                        th:text="${hoaDonChiTiet.sanPhamChiTiet.sanPham.thuongHieu.tenThuongHieu}"></td>
                                    <td class="text-center"
                                        th:text="${hoaDonChiTiet.sanPhamChiTiet.sanPham.xuatXu.quocGia}"></td>
                                    <td class="text-center"
                                        th:text="${(hoaDonChiTiet == null or hoaDonChiTiet.thanhTien == null or
                                        hoaDonChiTiet.thanhTien == 0) ? '0 VND' : #numbers.formatInteger(hoaDonChiTiet.thanhTien, 3, 'COMMA') + ' VND'}">

                                    </td>
                                    <td class="text-center">
                        <span th:class="${hoaDonChiTiet.sanPhamChiTiet.trangThai == 'ƒêang Ho·∫°t ƒê·ªông' ? 'badge bg-danger' : 'badge bg-success'}"
                              th:text="${hoaDonChiTiet.sanPhamChiTiet.trangThai}"></span>
                                    </td>
                                    <td>
                                        <input type="hidden" name="hoaDonChiTietId" th:value="${hoaDonChiTiet.id}">
                                        <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                        <button type="button" class="btn btn-danger" onclick="deleteProductOrder(this)">
                                            <i class="fas fa-trash"></i> X√≥a
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Ph·∫ßn T√†i Kho·∫£n Kh√°ch H√†ng -->
                    <div class="bill-footer" style="border: 2px solid; padding: 20px; margin-top: 20px;">
                        <div class="d-flex justify-content-between align-items-center lg">
                            <h3><i class="fas fa-user-circle" style="font-size: 24px;"></i> T√†i kho·∫£n</h3>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#customerModal">
                                <i class="fas fa-user"></i> Ch·ªçn t√†i kho·∫£n
                            </button>

                            <!-- Modal Ch·ªçn Kh√°ch H√†ng -->
                            <div class="modal fade" id="customerModal" tabindex="-1"
                                 aria-labelledby="customerModalLabel"
                                 aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="customerModalLabel">Danh s√°ch kh√°ch h√†ng</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <!-- N√∫t th√™m kh√°ch h√†ng -->
                                            <div class="d-flex justify-content-between mb-3">
                                                <!-- N√∫t th√™m kh√°ch h√†ng v·ªõi icon -->
                                                <button type="button" class="btn btn-success ms-auto" data-bs-toggle="modal"
                                                        data-bs-target="#addCustomerModal">
                                                    <i class="fas fa-plus"></i> Th√™m Kh√°ch H√†ng M·ªõi
                                                </button>
                                            </div>

                                            <!-- B·∫£ng danh s√°ch kh√°ch h√†ng -->
                                            <table class="table" id="productTable1">
                                                <thead>
                                                <tr>
                                                    <th  class="text-center">STT</th>
                                                    <th class="text-center">T√™n Kh√°ch H√†ng</th>
                                                    <th class="text-center">S·ªë ƒêi·ªán Tho·∫°i</th>
                                                    <th class="text-center">Email</th>
                                                    <th class="text-center">Ch·ªçn</th>
                                                </tr>
                                                </thead>
                                                <tbody id="customerTableBody">
                                                <tr th:each="khachHang,status : ${khachHangs}">
                                                    <td th:text="${status.index + 1}" class="text-center"></td>
                                                    <td th:text="${khachHang.hoTen}" class="text-center"></td>
                                                    <td th:text="${khachHang.soDienThoai}" class="text-center"></td>
                                                    <td th:text="${khachHang.email}" class="text-center"></td>
                                                    <td class="text-center">
                                                        <form onsubmit="event.preventDefault(); addCustomerToInvoice(this)">
                                                            <input type="hidden" name="hoaDonId"
                                                                   th:value="${hoaDon.id}">
                                                            <input type="hidden" name="khachHangId"
                                                                   th:value="${khachHang.id}">
                                                            <button type="submit" class="btn btn-primary">Ch·ªçn</button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                </tbody>
                                            </table>

                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <!-- Modal th√™m kh√°ch h√†ng m·ªõi -->
                        <div class="modal fade" id="addCustomerModal" tabindex="-1"
                             aria-labelledby="addCustomerModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="addCustomerModalLabel">Th√™m Kh√°ch H√†ng M·ªõi</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="addCustomerForm">
                                            <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                            <div class="mb-3">
                                                <label for="nguoiNhan" class="form-label">H·ªç T√™n</label>
                                                <input type="text" class="form-control" id="nguoiNhan"
                                                       name="nguoiNhan" placeholder="Nh·∫≠p h·ªç t√™n" required>
                                                <span class="text-danger" id="nguoiNhanError"></span>
                                            </div>

                                            <div class="mb-3">
                                                <label for="soDienThoai" class="form-label">S·ªë ƒêi·ªán Tho·∫°i</label>
                                                <input type="text" class="form-control" id="soDienThoai"
                                                       name="soDienThoai" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>
                                                <span class="text-danger" id="soDienThoaiError"></span>
                                            </div>

                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary"
                                                        data-bs-dismiss="modal">H·ªßy
                                                </button>
                                                <button type="submit" class="btn btn-primary">L∆∞u</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-center my-2">
                            <div class="p-4 rounded border bg-light w-100">
                                <!-- Ki·ªÉm tra xem c√≥ √≠t nh·∫•t 1 th√¥ng tin kh√°ch h√†ng -->
                                <div th:if="${hoaDon.nguoiNhan != null || hoaDon.soDienThoai != null || hoaDon.email != null}">
                                    <!-- T√™n Kh√°ch H√†ng -->
                                    <div class="row mb-3">
                                        <div class="col-md-6 fw-bold">T√™n Kh√°ch H√†ng:</div>
                                        <span class="col-md-6 fw-semibold"
                                              th:text="${hoaDon.nguoiNhan != null ? hoaDon.nguoiNhan : '(Kh√¥ng c√≥ t√™n)'}"></span>
                                    </div>

                                    <!-- S·ªë ƒêi·ªán Tho·∫°i -->
                                    <div class="row mb-3">
                                        <div class="col-md-6 fw-bold">S·ªë ƒêi·ªán Tho·∫°i:</div>
                                        <span class="col-md-6 text-muted"
                                              th:text="${hoaDon.soDienThoai != null ? hoaDon.soDienThoai : '(Kh√¥ng c√≥ s·ªë ƒëi·ªán tho·∫°i)'}"></span>
                                    </div>

                                    <!-- Email -->
                                    <div class="row mb-3">
                                        <div class="col-md-6 fw-bold">Email:</div>
                                        <span class="col-md-6 text-muted"
                                              th:text="${hoaDon.email != null ? hoaDon.email : '(Kh√¥ng c√≥ email)'}"></span>
                                    </div>
                                </div>

                                <!-- N·∫øu kh√¥ng c√≥ th√¥ng tin kh√°ch h√†ng -->
                                <div th:if="${hoaDon.nguoiNhan == null && hoaDon.soDienThoai == null && hoaDon.email == null}"
                                     class="row">
                                    <div class="col-md-12 text-danger fw-bold">Kh√°ch L·∫ª</div>
                                </div>
                            </div>

                            <!-- N√∫t x√≥a kh√°ch h√†ng (Ch·ªâ hi·ªÉn th·ªã n·∫øu hoaDon.khachHang != null) -->
                            <form th:if="${hoaDon.nguoiNhan != null && hoaDon.soDienThoai != null}"
                                  class="d-inline w-100">
                                <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                <button type="button"
                                        class="btn btn-link text-danger p-0 ms-2"
                                        title="X√≥a kh√°ch h√†ng"
                                        th:attr="data-hoaDonId=${hoaDon.id}"
                                        onclick="deleteCustomerFromInvoice(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </form>
                        </div>

                    </div>

                    <!-- Ph·∫ßn Thanh To√°n -->
                    <div class="payment-section" style="border: 2px solid; padding: 20px; margin-top: 20px;">
                        <div class="row">
                            <!-- C·ªôt th√¥ng tin giao h√†ng b√™n tr√°i -->
                            <div class="col-md-6">
                                <h3><i class="fas fa-shipping-fast" style="font-size: 24px;"></i> Th√¥ng tin giao h√†ng
                                </h3>

                                <div class="mt-3" id="shippingForm" style="display: none;">
                                    <div class="card card-body">
                                        <form id="updateShippingForm">
                                            <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">

                                            <!-- Tr·∫£ Sau (·∫®n m·∫∑c ƒë·ªãnh) -->
                                            <div class="info mb-4 d-flex align-items-center payLaterSection"
                                                 id="payLaterSection"
                                                 th:style="${hoaDon.loaiHoaDon != 'Giao H√†ng' ? 'display: none;' : 'display: flex;'}">
                                                <i class="fas fa-money-bill-wave me-2"></i>
                                                <span class="me-auto fw-bold">Tr·∫£ Sau:</span>
                                                <div class="form-check form-switch">
                                                    <input id="payLaterSwitch" class="form-check-input" type="checkbox"
                                                           th:data-hoa-don-id="${hoaDon.id}"
                                                           th:checked="${hoaDon.loaiGiaoDich == 'Tr·∫£ Sau'}">
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-12 mb-3">
                                                    <input type="text" name="nguoiNhan" class="form-control w-100"
                                                           id="shippingNguoiNhan"
                                                           th:value="${hoaDon.nguoiNhan != null ? hoaDon.nguoiNhan : ''}">
                                                    <span class="text-danger" id="shippingNguoiNhanError"></span>
                                                </div>

                                                <div class="col-md-12 mb-3">
                                                    <input type="text" name="soDienThoai" class="form-control w-100"
                                                           id="shippingSoDienThoai"
                                                           th:value="${hoaDon.soDienThoai != null ? hoaDon.soDienThoai : ''}">
                                                    <span class="text-danger" id="shippingSoDienThoaiError"></span>
                                                </div>

                                                <div class="col-md-12 mb-3">
                                                    <input type="text" name="diaChiCuThe" class="form-control w-100"
                                                           id="diaChiCuThe"
                                                           th:value="${hoaDon.diaChiCuThe != null ? hoaDon.diaChiCuThe : ''}"
                                                           placeholder="ƒê·ªãa ch·ªâ c·ª• th·ªÉ">
                                                    <span class="text-danger" id="diaChiCuTheError"></span>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-4 mb-3">
                                                        <select id="thanhPho" name="thanhPho" class="form-control">
                                                            <option th:value="${hoaDon.thanhPho != null ? hoaDon.thanhPho : ''}"
                                                                    th:text="${hoaDon.thanhPho != null ? hoaDon.thanhPho : 'Ch·ªçn T·ªânh/Th√†nh ph·ªë'}"></option>
                                                        </select>
                                                        <input type="hidden" id="thanhPhoHidden"
                                                               th:value="${hoaDon.thanhPho}">
                                                        <span class="text-danger" id="thanhPhoError"></span>
                                                    </div>

                                                    <div class="col-md-4 mb-3">
                                                        <select id="huyen" name="huyen" class="form-control">
                                                            <option th:value="${hoaDon.huyen != null ? hoaDon.huyen : ''}"
                                                                    th:text="${hoaDon.huyen != null ? hoaDon.huyen : 'Ch·ªçn Qu·∫≠n/Huy·ªán'}"></option>
                                                        </select>
                                                        <input type="hidden" id="huyenHidden"
                                                               th:value="${hoaDon.huyen}">
                                                        <span class="text-danger" id="huyenError"></span>
                                                    </div>

                                                    <div class="col-md-4 mb-3">
                                                        <select id="phuong" name="phuong" class="form-control">
                                                            <option th:value="${hoaDon.phuong != null ? hoaDon.phuong : ''}"
                                                                    th:text="${hoaDon.phuong != null ? hoaDon.phuong : 'Ch·ªçn Ph∆∞·ªùng/X√£'}"></option>
                                                        </select>
                                                        <input type="hidden" id="phuongHidden"
                                                               th:value="${hoaDon.phuong}">
                                                        <span class="text-danger" id="phuongError"></span>
                                                    </div>
                                                </div>

                                                <div class="form-group">
            <textarea id="ghiChu" placeholder="Nh·∫≠p ghi ch√∫ n·∫øu c√≥"
                      name="ghiChu" class="form-control"
                      rows="3" th:text="${hoaDon.ghiChu}"></textarea>
                                                </div>
                                            </div>

                                            <button type="submit" class="btn btn-primary w-100">C·∫≠p nh·∫≠t giao h√†ng</button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- C·ªôt th√¥ng tin thanh to√°n b√™n ph·∫£i -->
                            <div class="col-md-6">
                                <h3><i class="fas fa-wallet"></i> Th√¥ng tin thanh to√°n</h3>

                                <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
                                <div class="d-flex align-items-center mb-4">
                                    <span>
                                        <i class="fas fa-credit-card"></i>
                                        <strong>Ph∆∞∆°ng th·ª©c thanh to√°n: </strong>
                                        <span id="paymentMethodText"
                                              th:text="${hoaDon.phuongThucThanhToan != null ? hoaDon.phuongThucThanhToan.tenPhuongThuc : 'Ch∆∞a c√≥ ph∆∞∆°ng th·ª©c'}"></span>
                                    </span>

                                    <!-- M·ªü modal -->
                                    <button type="button" class="btn btn-outline-primary ms-auto" data-bs-toggle="modal"
                                            data-bs-target="#paymentModal">
                                        <i class="bi bi-credit-card"></i>
                                    </button>
                                    <!-- Modal ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n -->
                                    <div class="modal fade" id="paymentModal" tabindex="-1"
                                         aria-labelledby="paymentModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="paymentModalLabel">Ch·ªçn ph∆∞∆°ng th·ª©c
                                                        thanh
                                                        to√°n</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <form id="paymentMethodForm">
                                                        <input type="hidden" name="hoaDonId"
                                                               th:value="${hoaDon != null ? hoaDon.id : ''}">

                                                        <div class="mb-3">
                                                            <label class="form-label"><i class="fas fa-credit-card"></i>
                                                                Ph∆∞∆°ng th·ª©c thanh to√°n:</label>
                                                            <div class="btn-group w-100" role="group"
                                                                 aria-label="Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n">
                                                                <th:block
                                                                        th:each="phuongThucThanhToan : ${listPhuongThucThanhToan}">
                                                                    <input type="hidden" id="phiShip"
                                                                           th:value="${hoaDon.phiShip}">
                                                                    <input type="hidden" id="listPhieuGiamGia"
                                                                           th:value="${hoaDon.phieuGiamGia != null ? hoaDon.phieuGiamGia.giaTriGiam : 0}">
                                                                    <input type="radio" class="btn-check"
                                                                           name="phuongThucThanhToanId"
                                                                           th:id="'payment-' + ${phuongThucThanhToan.id}"
                                                                           th:value="${phuongThucThanhToan.id}"
                                                                           autocomplete="off">
                                                                    <label class="btn btn-outline-primary"
                                                                           th:for="'payment-' + ${phuongThucThanhToan.id}"
                                                                           th:text="${phuongThucThanhToan.tenPhuongThuc}"></label>
                                                                </th:block>
                                                            </div>
                                                        </div>


                                                        <!-- Form nh·∫≠p s·ªë ti·ªÅn (ch·ªâ hi·ªÉn th·ªã n·∫øu ch·ªçn Ti·ªÅn M·∫∑t) -->
                                                        <div id="paymentDetails">
                                                            <!-- N·ªôi dung ƒë·ªông s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                                        </div>

                                                        <button type="button" id="addPaymentMethodButton" class="btn btn-primary">
                                                            C·∫≠p nh·∫≠t
                                                        </button>

                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Phi·∫øu Gi·∫£m Gi√° -->
                                <div class="d-flex align-items-center mb-4">
                                    <span>
                                        <i class="fas fa-tag"></i>
                                        <strong>Phi·∫øu gi·∫£m gi√°: </strong>
                                        <span th:text="${hoaDon.phieuGiamGia != null ? hoaDon.phieuGiamGia.tenPhieuGiamGia : 'Ch∆∞a c√≥ phi·∫øu gi·∫£m gi√°'}"></span>
                                    </span>

                                    <!-- M·ªü modal ch·ªçn phi·∫øu gi·∫£m gi√° -->
                                    <button type="button" class="btn btn-outline-primary ms-auto" data-bs-toggle="modal"
                                            data-bs-target="#discountModal">
                                        <i class="fas fa-tag"></i>
                                    </button>

                                    <!-- Modal phi·∫øu gi·∫£m gi√° -->
                                    <div class="modal fade" id="discountModal" tabindex="-1"
                                         aria-labelledby="discountModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="discountModalLabel">Ch·ªçn phi·∫øu gi·∫£m
                                                        gi√°</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <form id="applyDiscountForm">
                                                        <input type="hidden" name="hoaDonId" id="hoaDonId"
                                                               th:value="${hoaDon != null ? hoaDon.id : ''}">
                                                        <div class="mb-3">
                                                            <div class="mb-3">
                                                                <label for="tenPhieuGiamGia" class="form-label fw-bold">
                                                                    <i class="bi bi-tags-fill text-primary"></i> Ch·ªçn Phi·∫øu Gi·∫£m Gi√°
                                                                </label>
                                                                <select id="tenPhieuGiamGia" name="tenPhieuGiamGia" class="form-select border-primary shadow-sm rounded-pill">
                                                                    <option value="">üö´ Kh√¥ng √°p d·ª•ng phi·∫øu gi·∫£m gi√°</option>
                                                                    <th:block th:if="${listPhieuGiamGia != null and not #lists.isEmpty(listPhieuGiamGia)}">
                                                                        <th:block th:each="phieuGiamGia : ${listPhieuGiamGia}">
                                                                            <option th:value="${phieuGiamGia.tenPhieuGiamGia}"
                                                                                    th:text="${phieuGiamGia.tenPhieuGiamGia +
                        ' ( ' + #numbers.formatInteger(phieuGiamGia.giaTriGiam, 3, 'COMMA') + ' VND ) ' +
                        (phieuGiamGia.dieuKien > 0 ? '( ƒêi·ªÅu Ki·ªán ‚â• ' + #numbers.formatInteger(phieuGiamGia.dieuKien, 3, 'COMMA') + ' VND )' : '')}">
                                                                            </option>
                                                                        </th:block>
                                                                    </th:block>
                                                                    <th:block th:if="${listPhieuGiamGia == null or #lists.isEmpty(listPhieuGiamGia)}">
                                                                        <option value="" disabled selected>‚õî Kh√¥ng c√≥ phi·∫øu gi·∫£m gi√°</option>
                                                                    </th:block>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <button type="button" class="btn btn-primary"
                                                                onclick="applyPhieuGiamGia(this)">√Åp d·ª•ng
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Giao H√†ng -->
                                <div class="info mb-4 d-flex align-items-center">
                                    <i class="fas fa-truck me-2"></i>
                                    <span class="me-auto fw-bold">Giao H√†ng:</span>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="deliverySwitch"
                                               th:data-hoa-don-id="${hoaDon.id}"
                                               th:checked="${hoaDon.loaiHoaDon == 'Giao H√†ng'}">
                                    </div>
                                </div>

                                <!-- Ph√≠ Ship -->
                                <div class="info mb-4">
                                    <span><i class="fas fa-box"></i> Ph√≠ Ship:</span>
                                    <span th:text="${hoaDon.phiShip != null ? (hoaDon.phiShip != 0 ? #numbers.formatInteger(hoaDon.phiShip, 3, 'COMMA') + ' VND' : '0 VND') : '0 VND'}"></span>
                                    <!--<span id="shippingFee">ƒêang t√≠nh...</span>-->
                                </div>

                                <!-- Ti·ªÅn h√†ng -->
                                <div class="info mb-4">
                                    <span><i class="fas fa-box"></i> Ti·ªÅn h√†ng:</span>
                                    <span th:text="${(hoaDon.tongTien != null && hoaDon.tongTien != 0) ?
                                    #numbers.formatInteger(hoaDon.tongTien +
                                    (hoaDon.phieuGiamGia != null ? hoaDon.phieuGiamGia.giaTriGiam : 0) -
                                    (hoaDon.phiShip != null ? hoaDon.phiShip : 0), 3, 'COMMA') + ' VNƒê'
                                    : '0 VND'}"></span>

                                </div>

                                <!-- Gi·∫£m Gi√° -->
                                <div class="info mb-4">
                                    <span><i class="fas fa-percent"></i> Gi·∫£m gi√°:</span>
                                    <span
                                            th:text="${(hoaDon.phieuGiamGia == null or hoaDon.phieuGiamGia.giaTriGiam == null or hoaDon.phieuGiamGia.giaTriGiam == 0) ? '0 VND' : #numbers.formatInteger(hoaDon.phieuGiamGia.giaTriGiam, 3, 'COMMA') + ' VND'}">
                                    </span>
                                </div>

                                <!-- T·ªïng Ti·ªÅn -->
                                <div class="info mb-3"><br>
                                    <!-- T·ªïng Ti·ªÅn -->
                                    <div class="info mb-3">
                                        <strong>T·ªïng ti·ªÅn:</strong>
                                        <strong>
                                            <span th:text="${(hoaDon.tongTien != null && hoaDon.tongTien != 0) ?
                                                    #numbers.formatInteger(hoaDon.tongTien, 3, 'COMMA') + ' VNƒê'
                                                    : '0 VNƒê'}"></span>
                                            <span data-bs-toggle="modal" data-bs-target="#infoModal">
                                                <i class="bi bi-question-circle"></i>
                                            </span>
                                        </strong>
                                    </div>

                                    <!-- Modal -->
                                    <div class="modal fade" id="infoModal" tabindex="-1"
                                         aria-labelledby="infoModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="infoModalLabel">C√°ch t√≠nh T·ªïng ti·ªÅn</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p>C√¥ng th·ª©c t√≠nh t·ªïng ti·ªÅn l√†:</p>
                                                    <ul>
                                                        <li><strong>T·ªïng Th√†nh Ti·ªÅn</strong> - <strong>Gi√° tr·ªã phi·∫øu gi·∫£m gi√°</strong> + <strong>Ph√≠ v·∫≠n chuy·ªÉn</strong></li>
                                                        <span th:text="${(hoaDon.tongTien != null && hoaDon.tongTien != 0) ?
        #numbers.formatInteger(hoaDon.tongTien +
        (hoaDon.phieuGiamGia != null ? hoaDon.phieuGiamGia.giaTriGiam : 0) -
        (hoaDon.phiShip != null ? hoaDon.phiShip : 0), 3, 'COMMA') + ' VNƒê' : '0 VNƒê'}"></span> -
                                                        <span th:text="${(hoaDon.phieuGiamGia != null && hoaDon.phieuGiamGia.giaTriGiam != 0) ?
        #numbers.formatInteger(hoaDon.phieuGiamGia.giaTriGiam, 3, 'COMMA') + ' VNƒê' : '0 VNƒê'}"></span> +
                                                        <span th:text="${(hoaDon.phiShip != null && hoaDon.phiShip != 0) ?
        #numbers.formatInteger(hoaDon.phiShip, 3, 'COMMA') + ' VNƒê' : '0 VNƒê'}"></span> =
                                                        <span th:text="${(hoaDon.tongTien != null && hoaDon.tongTien != 0) ?
        #numbers.formatInteger(hoaDon.tongTien, 3, 'COMMA') + ' VNƒê' : '0 VNƒê'}"></span>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- N√∫t m·ªü modal -->
                                <div class="confirm-button mt-3">
                                    <br>
                                    <button type="button" class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#confirmModal">
                                        <i class="fas fa-check-circle"></i> X√°c nh·∫≠n thanh to√°n
                                    </button>
                                </div>

                                <!-- Form x√°c nh·∫≠n thanh to√°n -->
                                <form id="paymentForm" th:action="@{/confirm-payment}" method="POST">
                                    <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}">
                                    <input type="hidden" id="successMessage" th:value="${successMessage}">
                                    <input type="hidden" id="errorMessage" th:value="${errorMessage}">
                                </form>

                                <!-- Modal x√°c nh·∫≠n -->
                                <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="confirmModalLabel">X√°c nh·∫≠n thanh to√°n</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <span th:text="${hoaDon.loaiHoaDon == 'T·∫°i Qu·∫ßy' ? 'B·∫°n c√≥ mu·ªën x√°c nh·∫≠n thanh to√°n h√≥a ƒë∆°n t·∫°i qu·∫ßy kh√¥ng?' : 'B·∫°n c√≥ mu·ªën x√°c nh·∫≠n thanh to√°n h√≥a ƒë∆°n giao h√†ng kh√¥ng?'}"></span>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                                                <button type="button" class="btn btn-success" id="confirmPayment">X√°c nh·∫≠n</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- /.box -->

        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <div th:replace="~{admin/fragments/footer :: footer}"></div>


</div>
<!-- ./wrapper -->

<!-- jQuery 3 -->

<div th:replace="~{admin/fragments/script :: script}"></div>

<script src="/js/shop.js"></script>

<script src="/js/main.js"></script>
<script src="/js/DangNhap/login.js"></script>
<script src="/js/DangNhap/logout.js"></script>

</body>
</html>
