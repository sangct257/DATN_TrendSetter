<div th:fragment="script">
    <script>
        function showToast(message, type) {
            const toast = document.getElementById("toast-message");
            const toastText = document.getElementById("toast-text");
            const toastLoadingBar = document.getElementById("toast-loading-bar").querySelector(".progress-bar");

            // Xóa tất cả các class màu trước đó
            toast.classList.remove("text-bg-primary", "text-bg-success", "text-bg-danger");
            toastLoadingBar.classList.remove("bg-light", "bg-success", "bg-danger");

            // Gán màu mới dựa trên loại thông báo
            toast.classList.add(`text-bg-${type}`);
            toastLoadingBar.classList.add(type === "primary" ? "bg-light" : type === "success" ? "bg-success" : "bg-danger");

            // Hiển thị toast
            toast.classList.remove("hide");
            toast.classList.add("show");
            toastText.textContent = message;
            toastLoadingBar.style.width = "0%";

            return toastLoadingBar;
        }
    </script>

    <!-- API Tạo Hóa Đơn -->
    <script th:inline="javascript">
        function createHoaDon() {
            fetch('/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => {
                    if (!response.ok) throw new Error(`Lỗi HTTP: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data && data.id) {
                        setTimeout(() => addHoaDonToUI(data), 1500);
                    }
                })
        }

        // Thêm hóa đơn mới vào danh sách hiển thị
        function addHoaDonToUI(hoaDon) {
            const container = document.querySelector(".row.g-4");

            const newCard = document.createElement("div");
            newCard.className = "col-12 col-sm-6 col-lg-4";
            newCard.innerHTML = `
        <div class="card border-primary shadow-sm position-relative rounded-3 overflow-hidden">
            <div class="position-absolute top-0 end-0 m-2">
                <button type="button" class="btn btn-sm btn-danger"
                        onclick="confirmDeleteHoaDon(this, '${hoaDon.id}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form action="/admin/sell-counter" method="GET">
                <input type="hidden" name="hoaDonId" value="${hoaDon.id}">
                <button type="submit" class="btn p-0 w-100">
                    <div class="card-header bg-primary text-white text-center py-3">
                        <h6># ${hoaDon.maHoaDon}</h6>
                    </div>
                    <div class="card-body text-center">
                        <p class="card-text text-muted">
                            <i class="fas fa-shopping-cart"></i> Số lượng Sản Phẩm:
                            <strong>${hoaDon.tongSanPham}</strong>
                        </p>
                    </div>
                    <div class="card-footer bg-light text-center">
                        <small class="text-muted">Chi tiết hóa đơn</small>
                    </div>
                </button>
            </form>
        </div>
    `;

            container.prepend(newCard);
        }
    </script>
    <!--API Delete Hóa Đơn-->
    <script>
        function confirmDeleteHoaDon(button, hoaDonId) {
            if (confirm("Bạn có chắc chắn muốn xóa hóa đơn này?")) {
                deleteHoaDon(button, hoaDonId);
            }
        }

        function deleteHoaDon(button, hoaDonId) {
            fetch(`/delete/${hoaDonId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        showToast(data.message, "success");

                        // Đợi 1.5 giây để hiển thị Toast rồi mới chuyển trang
                        setTimeout(() => {
                            const card = button.closest(".col-12.col-sm-6.col-lg-4");
                            if (card) card.remove();
                            window.location.href = "/admin/sell-counter";
                        }, 1500);
                    }
                })
        }

    </script>
    <!--API Thêm Khách Hàng-->
    <script>
        function addCustomerToInvoice(form) {
            const hoaDonId = form.querySelector('input[name="hoaDonId"]').value;
            const khachHangId = form.querySelector('input[name="khachHangId"]').value;

            fetch('/add-customer', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({hoaDonId, khachHangId})
            })
                .then(response => response.json())
                .then(data => {
                    setTimeout(() => {
                        if (data.message) {
                            showToast(data.message, "success");
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showToast(data.error, "danger");
                        }
                    }, 500);
                })
                .catch(error => {
                    console.error('Lỗi:', error);
                    setTimeout(() => {
                        showToast("Có lỗi xảy ra khi thêm khách hàng!", "danger");
                    }, 500);
                });
        }
    </script>
    <!--API Xóa Khách Hàng-->
    <script>
        function deleteCustomerFromInvoice(button) {
            const hoaDonId = button.getAttribute("data-hoaDonId");

            if (!hoaDonId || isNaN(hoaDonId)) {
                showToast("Lỗi: ID hóa đơn không hợp lệ!", "danger");
                return;
            }

            if (!confirm("Bạn có chắc chắn muốn xóa khách hàng khỏi hóa đơn?")) return;

            fetch('/delete-customer', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({hoaDonId})
            })
                .then(response => response.json())
                .then(data => {
                    setTimeout(() => {
                        if (data.message) {
                            showToast(data.message, "success");
                            setTimeout(() => location.reload(), 1000); // Reload trang sau khi xóa
                        } else {
                            showToast(data.error, "danger");
                        }
                    }, 500);
                })
                .catch(error => {
                    console.error('Lỗi:', error);
                    setTimeout(() => {
                        showToast("Lỗi khi xóa khách hàng!", "danger");
                    }, 500);
                });
        }
    </script>
    <!--API Phương Thức Thanh Toán-->
    <script>
        $(document).ready(function () {
            let paymentOptions = $("input[name='phuongThucThanhToanId']");
            let paymentDetails = $("#paymentDetails");
            let paymentMethodText = $("#paymentMethodText");

            // Lấy tổng tiền hóa đơn từ Thymeleaf
            let tongTienHoaDon = parseFloat('[[${hoaDon != null ? hoaDon.tongTien : 0}]]');

            // Xử lý khi chọn phương thức thanh toán
            paymentOptions.on("change", function () {
                let selectedText = $("label[for='" + this.id + "']").text().trim();
                paymentDetails.empty();

                if (selectedText === "Tiền Mặt") {
                    paymentDetails.html(`
                <div class="mb-3">
                    <label for="cashAmount" class="form-label"><i class="fas fa-money-bill-wave"></i> Nhập số tiền khách đưa:</label>
                    <input type="number" id="cashAmount" name="cashAmount" class="form-control" placeholder="Nhập số tiền khách đưa" min="0">
                </div>
                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-coins"></i> Số tiền thối lại:</label>
                    <input type="text" id="changeAmount" class="form-control" readonly>
                </div>
            `);

                    let cashInput = $("#cashAmount");
                    let changeOutput = $("#changeAmount");

                    cashInput.on("input", function () {
                        let cashGiven = parseFloat($(this).val()) || 0;
                        let phiShip = parseFloat($("#phiShip").val()) || 0;
                        let maGiamGia = parseFloat($("#listPhieuGiamGia").val()) || 0;
                        let totalAmount = tongTienHoaDon + phiShip - maGiamGia;

                        let change = cashGiven - totalAmount;
                        changeOutput.val(change < 0 ? `Thiếu ${Math.abs(change).toLocaleString()} VND` : `${change.toLocaleString()} VND`)
                            .css("color", change < 0 ? "red" : "green");
                    });

                } else if (selectedText === "Chuyển Khoản") {
                    paymentDetails.html(`
                <div class="mb-3 text-center">
                    <img id="qrCodeImage" src="http://localhost:8080/images/path-to-qr-code.jpg" alt="QR Code" class="img-fluid" style="max-width: 250px;">
                </div>
            `);
                }
            });

            // Xử lý khi nhấn nút "Cập nhật" để chọn phương thức thanh toán
            $("#addPaymentMethodButton").on("click", function () {
                let formData = $("#paymentMethodForm").serialize();
                let selectedPayment = $("input[name='phuongThucThanhToanId']:checked").val();

                if (!selectedPayment) {
                    showToast("Vui lòng chọn phương thức thanh toán!", "error");
                    return;
                }


                $.ajax({
                    url: '/add-payment-method',
                    method: 'POST',
                    data: formData,
                    beforeSend: function () {
                        $("#addPaymentMethodButton").prop("disabled", true);
                    },
                    success: function (response) {
                        setTimeout(() => {
                            if (response.success) {
                                paymentMethodText.text(response.updatedPaymentMethod);
                                $("#paymentModal").modal("hide");
                                showToast("Cập nhật phương thức thanh toán thành công!", "success");

                                setTimeout(() => {
                                    location.reload();
                                }, 800);
                            } else {
                                showToast(response.message || "Cập nhật không thành công!", "error");
                            }
                        }, 400);
                    },
                    error: function (xhr) {
                        setTimeout(() => {
                            showToast("Lỗi: " + xhr.responseText, "error");
                        }, 400);
                    },
                    complete: function () {
                        $("#addPaymentMethodButton").prop("disabled", false);
                    }
                });
            });
        });

    </script>
    <!--API Thay Đổi Loại Giao Hàng và Trả Sau-->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const deliverySwitch = document.querySelector("#deliverySwitch");
            const payLaterSwitch = document.querySelector("#payLaterSwitch");

            function toggleSections(isChecked) {
                document.getElementById("shippingForm").style.display = isChecked ? "block" : "none";
                document.getElementById("payLaterSection").style.display = isChecked ? "block" : "none";
            }

            if (deliverySwitch) {
                toggleSections(deliverySwitch.checked);
                deliverySwitch.addEventListener("change", function () {
                    toggleSections(this.checked);
                });
            }

            if (payLaterSwitch) {
                payLaterSwitch.addEventListener("change", function () {
                    document.getElementById("payLaterSection").style.display = this.checked ? "block" : "none";
                });
            }

            // Gửi yêu cầu cập nhật API khi có thay đổi
            document.querySelectorAll(".form-check-input").forEach((checkbox) => {
                checkbox.addEventListener("change", function () {
                    const hoaDonId = this.getAttribute("data-hoa-don-id");
                    const isChecked = this.checked;

                    const apiUrl = this.id === "deliverySwitch"
                        ? `/api/hoa-don/toggle-delivery/${hoaDonId}`
                        : `/cap-nhat-loai-giao-dich/${hoaDonId}`;

                    fetch(apiUrl, {
                        method: "PUT",
                        headers: {"Content-Type": "application/json"}
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.successMessage) {
                                this.checked = isChecked;
                                if (this.id === "deliverySwitch") {
                                    updateDeliveryUI(this.checked, data.loaiHoaDon);
                                } else {
                                    updateTransactionUI(this.checked, data.loaiGiaoDich);
                                }
                                location.reload(); // Thêm reload sau khi cập nhật thành công
                            } else {
                                showToast(data.errorMessage || "Cập nhật thất bại!", "danger");
                                this.checked = !isChecked;
                            }
                        })
                        .catch(error => {
                            console.error("Lỗi API:", error);
                            showToast("Lỗi kết nối đến server!", "danger");
                            this.checked = !isChecked;
                        });
                });
            });
        });

        // ✅ Cập nhật UI khi thay đổi trạng thái giao hàng
        function updateDeliveryUI(isChecked, loaiHoaDon) {
            document.getElementById("shippingForm").style.display = isChecked ? "block" : "none";
            document.getElementById("payLaterSection").style.display = isChecked ? "block" : "none";
            const orderStatusElement = document.getElementById("orderStatus");
            if (orderStatusElement) orderStatusElement.textContent = loaiHoaDon;

            const confirmModalText = document.querySelector("#confirmModal .modal-body span");
            if (confirmModalText) {
                confirmModalText.textContent = isChecked
                    ? "Bạn có muốn xác nhận thanh toán hóa đơn giao hàng không?"
                    : "Bạn có muốn xác nhận thanh toán hóa đơn tại quầy không?";
            }
        }

        // ✅ Cập nhật UI khi thay đổi loại giao dịch
        function updateTransactionUI(isChecked, loaiGiaoDich) {
            const transactionStatus = document.getElementById("transactionStatus");
            if (transactionStatus) transactionStatus.textContent = loaiGiaoDich;
        }

        // ✅ Hiển thị thông báo nhanh
        function showToast(message, type = "success") {
            const toastContainer = document.getElementById("toastContainer");
            if (!toastContainer) return;

            const toast = document.createElement("div");
            toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
            toast.style.position = "absolute";
            toast.style.top = "20px";
            toast.style.right = "20px";
            toast.style.zIndex = "1050";

            toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove("show");
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }
    </script>
    <!--API Phiếu Giảm Giá-->
    <script>
        function applyPhieuGiamGia(button) {
            const hoaDonId = document.getElementById("hoaDonId").value;
            const tenPhieuGiamGia = document.getElementById("tenPhieuGiamGia").value;

            if (!hoaDonId || isNaN(hoaDonId)) {
                showToast("Lỗi: ID hóa đơn không hợp lệ!", "danger");
                return;
            }

            if (!tenPhieuGiamGia) {
                showToast("Vui lòng chọn phiếu giảm giá.", "warning");
                return;
            }

            button.disabled = true;
            button.innerText = "Đang áp dụng...";

            fetch('/apply-phieu-giam-gia', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({hoaDonId, tenPhieuGiamGia})
            })
                .then(response => response.json().catch(() => ({
                    success: false,
                    error: "Phản hồi không hợp lệ từ server"
                })))
                .then(data => {
                    if (data.success) {
                        showToast("Phiếu giảm giá đã được áp dụng!", "success");

                        let modal = bootstrap.Modal.getInstance(document.getElementById("discountModal"));
                        modal.hide();

                        setTimeout(() => {
                            location.reload();
                        }, 500);
                    } else {
                        showToast(data.error || "Lỗi khi áp dụng phiếu giảm giá!", "danger");
                    }
                })
                .catch(error => {
                    console.error('Lỗi:', error);
                    showToast("Lỗi hệ thống, vui lòng thử lại sau!", "danger");
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerText = "Áp dụng";
                });
        }
    </script>
    <!--API Update Địa Chỉ Giao Hàng-->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("#updateShippingForm");

            form.addEventListener("submit", function (event) {
                event.preventDefault(); // Ngăn chặn gửi form mặc định

                const formData = new FormData(form);
                const hoaDonId = formData.get("hoaDonId");

                if (!hoaDonId || isNaN(hoaDonId)) {
                    showToast("Lỗi: ID hóa đơn không hợp lệ!", "danger");
                    return;
                }

                fetch("/update-shipping", {
                    method: "PUT",
                    headers: {"Content-Type": "application/x-www-form-urlencoded"},
                    body: new URLSearchParams([...formData])
                })
                    .then(response => {
                        if (!response.ok) { // Kiểm tra xem phản hồi có thành công không
                            throw new Error("Error response from server");
                        }
                        return response.json();
                    })
                    .then(data => {
                        setTimeout(() => {
                            showToast(data.message || data.error, data.message ? "success" : "danger");
                            if (data.message) {
                                setTimeout(() => location.reload(), 1000); // Reload trang sau khi cập nhật
                            }
                        }, 500);
                    })
                    .catch(error => {
                        console.error("Lỗi:", error);
                        setTimeout(() => {
                            showToast("Lỗi khi cập nhật địa chỉ giao hàng!", "danger");
                        }, 500);
                    });
            });
        });
    </script>
    <!-- API Update New Khách Hàng -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("#addCustomerForm");

            if (!form) {
                console.warn("Không tìm thấy form #addCustomerForm");
                return;
            }

            form.addEventListener("submit", function (event) {
                event.preventDefault(); // Ngăn chặn gửi form mặc định

                const formData = new FormData(form);
                const hoaDonId = formData.get("hoaDonId");
                const nguoiNhan = formData.get("nguoiNhan");
                const soDienThoai = formData.get("soDienThoai");

                // Kiểm tra ID hóa đơn và thông tin người nhận hợp lệ
                if (!hoaDonId || isNaN(hoaDonId)) {
                    showToast("Lỗi: ID hóa đơn không hợp lệ!", "danger");
                    return;
                }
                if (!nguoiNhan || nguoiNhan.trim() === "") {
                    showToast("Lỗi: Họ tên không được để trống!", "danger");
                    return;
                }
                if (!soDienThoai || soDienThoai.trim() === "") {
                    showToast("Lỗi: Số điện thoại không được để trống!", "danger");
                    return;
                }

                // Gửi yêu cầu đến API
                fetch("/add-new-customer", {
                    method: "POST",
                    body: formData,
                })
                    .then(response => response.json().then(data => {
                        if (!response.ok) {
                            throw new Error(data.error || "Lỗi từ server");
                        }
                        return data;
                    }))
                    .then(data => {
                        setTimeout(() => {
                            showToast(data.success || data.error, data.success ? "success" : "danger");
                            if (data.success) {
                                setTimeout(() => location.reload(), 1000); // Reload trang sau khi cập nhật
                            }
                        }, 500);
                    })
                    .catch(error => {
                        console.error("Lỗi:", error);
                        setTimeout(() => {
                            showToast("Lỗi khi cập nhật thông tin khách hàng!", "danger");
                        }, 500);
                    });
            });
        });
    </script>
    <!--API Add Sản Phẩm-->
    <script>
        function addProductOrder(button) {
            const sanPhamChiTietId = parseInt(button.closest('tr').querySelector('td:first-child').textContent.trim(), 10);
            const hoaDonId = parseInt(document.querySelector('input[name="hoaDonId"]').value, 10);
            const soLuong = parseInt(button.closest('tr').querySelector('input[name="soLuong"]').value, 10);

            const data = {
                sanPhamChiTietId: sanPhamChiTietId,
                hoaDonId: hoaDonId,
                soLuong: soLuong
            };

            fetch('/add-product-order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(handleResponse)
                .catch(handleError);

            function handleResponse(response) {
                if (response.successMessage) {
                    showToast(response.successMessage, "success");

                    // Lưu vị trí cuộn trước khi reload
                    sessionStorage.setItem('scrollPosition', window.scrollY);

                    // Điều hướng theo trạng thái hóa đơn
                    closeModalAndReload(response.trangThai);
                } else {
                    showToast(response.errorMessage || "Đặt hàng thất bại!", "danger");
                }
            }

            function handleError(error) {
                console.error("Lỗi khi gửi yêu cầu:", error);
                showToast("Có lỗi xảy ra: " + error.message, "danger");
            }

            function closeModalAndReload(trangThai) {
                const modalElement = document.getElementById('addProductModal');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                    modal.hide();
                }

                setTimeout(() => {
                    let redirectUrl;
                    if (trangThai === "Đang Xử Lý") {
                        redirectUrl = `http://localhost:8080/admin/sell-counter?hoaDonId=${hoaDonId}`;
                    } else if (trangThai === "Chờ Xác Nhận") {
                        redirectUrl = `http://localhost:8080/admin/order-details?hoaDonId=${hoaDonId}`;
                    } else {
                        redirectUrl = `http://localhost:8080/admin/sell-counter?hoaDonId=${hoaDonId}`;
                    }

                    window.location.href = redirectUrl;
                }, 1000);
            }
        }

        // Cuộn về vị trí đã lưu sau khi tải lại trang
        window.onload = function () {
            const scrollPosition = sessionStorage.getItem('scrollPosition');
            if (scrollPosition) {
                window.scrollTo({top: parseInt(scrollPosition, 10), behavior: "smooth"});
                sessionStorage.removeItem('scrollPosition'); // Xóa vị trí sau khi đã cuộn
            }
        };
    </script>
    <!--API Update Số Lượng-->
    <script>
        function updateQuantityOrder(input) {
            const hoaDonChiTietId = parseInt(input.closest('tr').querySelector('input[name="hoaDonChiTietId"]').value, 10);
            const hoaDonId = parseInt(document.querySelector('input[name="hoaDonId"]').value, 10);
            const soLuong = parseInt(input.value, 10);

            if (isNaN(hoaDonChiTietId) || isNaN(hoaDonId) || isNaN(soLuong) || soLuong < 1) {
                showToast("Thông tin không hợp lệ!", "danger");
                return;
            }

            const data = {
                hoaDonChiTietId: hoaDonChiTietId,
                hoaDonId: hoaDonId,
                soLuong: soLuong
            };


            fetch('/update-product-order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(handleResponse)
                .catch(handleError)
                .finally(() => {
                });

            function handleResponse(response) {
                if (response.successMessage) {
                    showToast(response.successMessage, "success");
                    sessionStorage.setItem('scrollPosition', window.scrollY);
                    closeModalAndReload(response.trangThai);
                } else {
                    showToast(response.errorMessage || "Cập nhật không thành công!", "danger");
                }
            }

            function handleError(error) {
                console.error("Lỗi khi gửi yêu cầu:", error);
                showToast("Có lỗi xảy ra: " + error.message, "danger");
            }

            function closeModalAndReload(trangThai) {
                setTimeout(() => {
                    let toastLoading = document.getElementById("toast-loading");
                    if (toastLoading) {
                        hideToast(toastLoading);
                    }
                    let redirectUrl;
                    if (trangThai === "Đang Xử Lý") {
                        redirectUrl = `http://localhost:8080/admin/sell-counter?hoaDonId=${hoaDonId}`;
                    } else if (trangThai === "Chờ Xác Nhận") {
                        redirectUrl = `http://localhost:8080/admin/order-details?hoaDonId=${hoaDonId}`;
                    } else {
                        redirectUrl = `http://localhost:8080/admin/sell-counter?hoaDonId=${hoaDonId}`;
                    }
                    window.location.href = redirectUrl;
                }, 1000);
            }
        }


        function hideToast(toastElement) {
            if (toastElement) {
                try {
                    const toast = new bootstrap.Toast(toastElement);
                    toast.hide();
                } catch (error) {
                    console.warn("Không thể ẩn toast:", error);
                }
            }
        }

        window.onload = function () {
            const scrollPosition = sessionStorage.getItem('scrollPosition');
            if (scrollPosition) {
                window.scrollTo({top: parseInt(scrollPosition, 10), behavior: "smooth"});
                sessionStorage.removeItem('scrollPosition');
            }
        };
    </script>
    <!--API Delete Sản Phẩm-->
    <script>
        function deleteProductOrder(button) {
            const hoaDonChiTietId = parseInt(button.closest('tr').querySelector('input[name="hoaDonChiTietId"]').value, 10);
            const hoaDonId = parseInt(document.querySelector('input[name="hoaDonId"]').value, 10);

            if (isNaN(hoaDonChiTietId) || isNaN(hoaDonId)) {
                showToast("Thông tin không hợp lệ!", "danger");
                return;
            }

            const data = {
                hoaDonChiTietId: hoaDonChiTietId,
                hoaDonId: hoaDonId
            };


            fetch('/delete-product-order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(handleResponse)
                .catch(handleError)
                .finally(() => {
                });

            function handleResponse(response) {
                if (response.successMessage) {
                    showToast(response.successMessage, "success");
                    sessionStorage.setItem('scrollPosition', window.scrollY);
                    closeModalAndReload(response.trangThai);
                } else {
                    showToast(response.errorMessage || "Xóa sản phẩm thất bại!", "danger");
                }
            }

            function handleError(error) {
                console.error("Lỗi khi gửi yêu cầu:", error);
                showToast("Có lỗi xảy ra: " + error.message, "danger");
            }

            function closeModalAndReload(trangThai) {
                const modalElement = document.getElementById('addProductModal');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                    modal.hide();
                }

                setTimeout(() => {
                    let toastLoading = document.getElementById("toast-loading");
                    if (toastLoading) {
                        hideToast(toastLoading);
                    }

                    let redirectUrl;
                    if (trangThai === "Đang Xử Lý") {
                        redirectUrl = `http://localhost:8080/admin/sell-counter?hoaDonId=${hoaDonId}`;
                    } else if (trangThai === "Chờ Xác Nhận") {
                        redirectUrl = `http://localhost:8080/admin/order-details?hoaDonId=${hoaDonId}`;
                    } else {
                        redirectUrl = `http://localhost:8080/admin/sell-counter?hoaDonId=${hoaDonId}`;
                    }

                    window.location.href = redirectUrl;
                }, 1000);
            }
        }


        function hideToast(toastElement) {
            if (toastElement) {
                try {
                    const toast = new bootstrap.Toast(toastElement);
                    toast.hide();
                } catch (error) {
                    console.warn("Không thể ẩn toast:", error);
                }
            }
        }

        // Cuộn về vị trí đã lưu sau khi tải lại trang
        window.onload = function () {
            const scrollPosition = sessionStorage.getItem('scrollPosition');
            if (scrollPosition) {
                window.scrollTo({top: parseInt(scrollPosition, 10), behavior: "smooth"});
                sessionStorage.removeItem('scrollPosition');
            }
        };
    </script>
    <!-- Script xử lý thanh toán -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const confirmButton = document.getElementById("confirmPayment");
            const paymentForm = document.getElementById("paymentForm");

            if (confirmButton && paymentForm) {
                confirmButton.addEventListener("click", function () {
                    paymentForm.submit();
                });
            } else {
                console.warn("Không tìm thấy phần tử 'confirmPayment' hoặc 'paymentForm'");
            }
        });
    </script>
    <!--API Giao Hàng Nhanh-->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const thanhPhoSelect = document.getElementById("thanhPho");
            const huyenSelect = document.getElementById("huyen");
            const phuongSelect = document.getElementById("phuong");

            const thanhPhoHidden = document.getElementById("thanhPhoHidden");
            const huyenHidden = document.getElementById("huyenHidden");
            const phuongHidden = document.getElementById("phuongHidden");

            function fetchProvinces(selectedValue = "") {
                fetch("/api/ghn/provinces")
                    .then(response => response.json())
                    .then(data => {
                        thanhPhoSelect.innerHTML = '<option value="">Chọn Tỉnh/Thành phố</option>';
                        let selectedProvinceId = "";

                        data.data.forEach(province => {
                            const selected = province.ProvinceName === selectedValue ? "selected" : "";
                            if (selected) selectedProvinceId = province.ProvinceID;
                            thanhPhoSelect.innerHTML += `<option value="${province.ProvinceName}" data-id="${province.ProvinceID}" ${selected}>${province.ProvinceName}</option>`;
                        });

                        if (selectedProvinceId) fetchDistricts(selectedProvinceId, huyenHidden.value);
                    })
                    .catch(error => console.error("Lỗi khi lấy danh sách tỉnh/thành phố:", error));
            }

            function fetchDistricts(provinceId, selectedValue = "") {
                fetch(`/api/ghn/districts?province_id=${provinceId}`)
                    .then(response => response.json())
                    .then(data => {
                        huyenSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
                        let selectedDistrictId = "";

                        data.data.forEach(district => {
                            const selected = district.DistrictName === selectedValue ? "selected" : "";
                            if (selected) selectedDistrictId = district.DistrictID;
                            huyenSelect.innerHTML += `<option value="${district.DistrictName}" data-id="${district.DistrictID}" ${selected}>${district.DistrictName}</option>`;
                        });

                        if (selectedDistrictId) fetchWards(selectedDistrictId, phuongHidden.value);
                    })
                    .catch(error => console.error("Lỗi khi lấy danh sách quận/huyện:", error));
            }

            function fetchWards(districtId, selectedValue = "") {
                fetch(`/api/ghn/wards?district_id=${districtId}`)
                    .then(response => response.json())
                    .then(data => {
                        phuongSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';

                        data.data.forEach(ward => {
                            const selected = ward.WardName === selectedValue ? "selected" : "";
                            phuongSelect.innerHTML += `<option value="${ward.WardName}" data-id="${ward.WardCode}" ${selected}>${ward.WardName}</option>`;
                        });
                    })
                    .catch(error => console.error("Lỗi khi lấy danh sách phường/xã:", error));
            }

            // Cập nhật giá trị ẩn khi thay đổi lựa chọn
            thanhPhoSelect.addEventListener("change", function () {
                const selectedOption = this.options[this.selectedIndex];
                const provinceId = selectedOption.getAttribute("data-id");

                thanhPhoHidden.value = selectedOption.value;
                huyenHidden.value = "";
                phuongHidden.value = "";

                huyenSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
                phuongSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';

                if (provinceId) {
                    fetchDistricts(provinceId);
                }
            });

            huyenSelect.addEventListener("change", function () {
                const selectedOption = this.options[this.selectedIndex];
                const districtId = selectedOption.getAttribute("data-id");

                huyenHidden.value = selectedOption.value;
                phuongHidden.value = "";

                phuongSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';

                if (districtId) {
                    fetchWards(districtId);
                }
            });

            phuongSelect.addEventListener("change", function () {
                phuongHidden.value = this.value;
            });

            // Nếu có dữ liệu cũ, hiển thị trước rồi cho phép thay đổi
            if (thanhPhoHidden.value) {
                fetchProvinces(thanhPhoHidden.value);
            } else {
                fetchProvinces();
            }
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('hidden.bs.modal', function () {
                    let backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = 'auto';
                });
            });
        });

    </script>
    <!--Validate-->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const addCustomerForm = document.getElementById("addCustomerForm");
            const hoaDonId = addCustomerForm?.getAttribute("data-hoa-don-id");

            // Chỉ chạy nếu hoaDonId hợp lệ
            if (!hoaDonId || isNaN(hoaDonId) || hoaDonId.trim() === "") {
                return;
            }

            addCustomerForm.addEventListener("submit", function (event) {
                let isValid = true;

                // Lấy giá trị input
                let nguoiNhan = document.getElementById("nguoiNhan").value.trim();
                let soDienThoai = document.getElementById("soDienThoai").value.trim();

                // Xóa thông báo lỗi cũ
                document.getElementById("nguoiNhanError").innerText = "";
                document.getElementById("soDienThoaiError").innerText = "";

                // Kiểm tra họ tên (phải có ít nhất 2 từ)
                if (nguoiNhan === "") {
                    document.getElementById("nguoiNhanError").innerText = "Họ tên không được để trống.";
                    isValid = false;
                } else if (!/^[A-Za-zÀ-ỹ\s]+$/.test(nguoiNhan)) {
                    document.getElementById("nguoiNhanError").innerText = "Họ tên chỉ được chứa chữ cái.";
                    isValid = false;
                } else if (!/^\S+\s+\S+/.test(nguoiNhan)) {
                    document.getElementById("nguoiNhanError").innerText = "Vui lòng nhập đầy đủ họ và tên.";
                    isValid = false;
                }

                // Kiểm tra số điện thoại (10-11 chữ số)
                if (!/^\d{10,11}$/.test(soDienThoai)) {
                    document.getElementById("soDienThoaiError").innerText = "Số điện thoại phải từ 10-11 số.";
                    isValid = false;
                }

                // Nếu có lỗi, ngăn form submit
                if (!isValid) {
                    event.preventDefault();
                }
            });
        });
    </script>
    <!--Load table-->
    <script>
        $(document).ready(function () {
            $('#productTable').DataTable({
                "paging": true,
                "lengthMenu": [5, 10, 20],
                "pageLength": 5,
                "autoWidth": false,
                "responsive": true,
                "language": {
                    "sProcessing": "Đang xử lý...",
                    "sLengthMenu": "Hiển thị _MENU_ dòng",
                    "sZeroRecords": "Không tìm thấy dữ liệu",
                    "sInfo": "Hiển thị _START_ đến _END_ trong tổng _TOTAL_ dòng",
                    "sInfoEmpty": "Không có dữ liệu để hiển thị",
                    "sInfoFiltered": "(lọc từ _MAX_ dòng)",
                    "sSearch": "Tìm kiếm:",
                    "oPaginate": {
                        "sFirst": "Đầu",
                        "sPrevious": "Trước",
                        "sNext": "Tiếp",
                        "sLast": "Cuối"
                    }
                }
            });
        });
    </script>
</div>