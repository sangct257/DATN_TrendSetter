<div th:fragment="script">
    <!-- Hi·ªÉn th·ªã Toast Notification -->
    <script>
        function showToast(message, type) {
            const toast = document.getElementById("toast-message");
            const toastText = document.getElementById("toast-text");

            if (!toast || !toastText) {
                console.error("‚ùå Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ Toast!");
                return;
            }

            // C·∫≠p nh·∫≠t n·ªôi dung
            toastText.textContent = message;

            // ƒê·∫∑t m√†u n·ªÅn d·ª±a tr√™n lo·∫°i th√¥ng b√°o
            toast.classList.remove("text-bg-primary", "text-bg-success", "text-bg-danger");
            toast.classList.add(`text-bg-${type}`);

            // Hi·ªÉn th·ªã Toast b·∫±ng Bootstrap API
            const toastBootstrap = new bootstrap.Toast(toast, { delay: 3000 });
            toastBootstrap.show();
        }

        function hideToast(button) {
            const toast = button.closest(".toast"); // L·∫•y ph·∫ßn t·ª≠ cha g·∫ßn nh·∫•t c√≥ class 'toast'
            if (toast) {
                const bsToast = bootstrap.Toast.getInstance(toast);
                if (bsToast) {
                    bsToast.hide();
                }
                setTimeout(() => toast.remove(), 300); // X√≥a toast sau animation
            }
        }

    </script>
    <!-- API T·∫°o H√≥a ƒê∆°n -->
    <script>
        function createHoaDon() {
            fetch('/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => {
                    if (!response.ok) throw new Error(`L·ªói HTTP: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ H√≥a ƒë∆°n ƒë∆∞·ª£c t·∫°o:', data);
                    if (data && data.id) {
                        console.log("üì¢ G·ªçi showToast()");
                        showToast("üéâ H√≥a ƒë∆°n ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!", "success"); // Hi·ªÉn th·ªã Toast tr∆∞·ªõc

                        // ‚è≥ ƒê·ª£i Toast hi·ªÉn th·ªã r·ªìi m·ªõi th√™m h√≥a ƒë∆°n
                        setTimeout(() => {
                            addHoaDonToUI(data);
                        }, 1500); // Delay 1.5 gi√¢y ƒë·ªÉ Toast hi·ªÉn th·ªã tr∆∞·ªõc
                    } else {
                        console.warn("‚ö†Ô∏è API kh√¥ng tr·∫£ v·ªÅ ID h√≥a ƒë∆°n h·ª£p l·ªá:", data);
                        showToast("‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫°o h√≥a ƒë∆°n!", "warning");
                    }
                })
                .catch(error => {
                    console.error('‚ùå L·ªói khi t·∫°o h√≥a ƒë∆°n:', error);
                    showToast("üö® C√≥ l·ªói x·∫£y ra khi t·∫°o h√≥a ƒë∆°n!", "danger");
                });
        }

        // Th√™m h√≥a ƒë∆°n m·ªõi v√†o danh s√°ch hi·ªÉn th·ªã
        function addHoaDonToUI(hoaDon) {
            const container = document.querySelector(".row.g-4");

            const newCard = document.createElement("div");
            newCard.className = "col-12 col-sm-6 col-lg-4";
            newCard.innerHTML = `
        <div class="card border-primary shadow-sm position-relative rounded-3 overflow-hidden">
            <div class="position-absolute top-0 end-0 m-2">
                <input type="hidden" name="hoaDonId" value="${hoaDon.id}">
                <button type="button"
                        class="btn btn-sm btn-danger d-flex align-items-center justify-content-center p-0"
                        style="width: 30px; height: 30px; border-radius: 50%;"
                        title="X√≥a h√≥a ƒë∆°n"
                        onclick="confirmDeleteHoaDon(this, '${hoaDon.id}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form action="/admin/sell-counter" method="GET" class="w-100">
                <input type="hidden" name="hoaDonId" value="${hoaDon.id}">
                <button type="submit" class="btn p-0 w-100 text-start">
                    <div class="card-header bg-primary text-white text-center py-3">
                        <h6 class="mb-0 text-uppercase"># ${hoaDon.maHoaDon}</h6>
                    </div>
                    <div class="card-body text-center">
                        <p class="card-text text-muted">
                            <i class="fas fa-shopping-cart"></i> S·ªë l∆∞·ª£ng s·∫£n ph·∫©m:
                            <strong>${hoaDon.tongSanPham}</strong>
                        </p>
                    </div>
                    <div class="card-footer bg-light text-center">
                        <small class="text-muted">Chi ti·∫øt h√≥a ƒë∆°n</small>
                    </div>
                </button>
            </form>
        </div>
    `;

            container.prepend(newCard); // Th√™m h√≥a ƒë∆°n m·ªõi l√™n ƒë·∫ßu danh s√°ch
        }
    </script>
    <!--API Delete H√≥a ƒê∆°n-->
    <script>
        function confirmDeleteHoaDon(button, hoaDonId) {
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√≥a ƒë∆°n n√†y?")) {
                deleteHoaDon(button, hoaDonId);
            }
        }

        function deleteHoaDon(button, hoaDonId) {
            fetch(`/delete/${hoaDonId}`, {method: 'POST', headers: {'Content-Type': 'application/json'}})
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        showToast(data.message, "success");

                        // X√≥a ph·∫ßn t·ª≠ h√≥a ƒë∆°n kh·ªèi giao di·ªán
                        const card = button.closest(".col-12.col-sm-6.col-lg-4");
                        if (card) {
                            setTimeout(() => {
                                card.remove(); // X√≥a h√≥a ƒë∆°n kh·ªèi giao di·ªán m√† kh√¥ng reload
                                window.location.href = "/admin/sell-counter";
                            }, 1000);
                        }
                    } else {
                        showToast(data.error, "danger");
                    }
                })
                .catch(error => {
                    console.error('L·ªói:', error);
                    showToast("C√≥ l·ªói x·∫£y ra khi x√≥a h√≥a ƒë∆°n!", "danger");
                });
        }

    </script>
    <!--API Th√™m Kh√°ch H√†ng-->
    <script>
        function addCustomerToInvoice(form) {
            const hoaDonId = form.querySelector('input[name="hoaDonId"]').value;
            const khachHangId = form.querySelector('input[name="khachHangId"]').value;

            fetch('/add-customer', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({hoaDonId, khachHangId})
            })
                .then(response => response.json())
                .then(data => {
                    setTimeout(() => {
                        if (data.message) {
                            showToast(data.message, "success");
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showToast(data.error, "danger");
                        }
                    }, 500);
                })
                .catch(error => {
                    console.error('L·ªói:', error);
                    setTimeout(() => {
                        showToast("C√≥ l·ªói x·∫£y ra khi th√™m kh√°ch h√†ng!", "danger");
                    }, 500);
                });
        }
    </script>
    <!--API X√≥a Kh√°ch H√†ng-->
    <script>
        function deleteCustomerFromInvoice(button) {
            const hoaDonId = button.getAttribute("data-hoaDonId");

            if (!hoaDonId || isNaN(hoaDonId)) {
                showToast("L·ªói: ID h√≥a ƒë∆°n kh√¥ng h·ª£p l·ªá!", "danger");
                return;
            }

            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng kh·ªèi h√≥a ƒë∆°n?")) return;

            fetch('/delete-customer', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({hoaDonId})
            })
                .then(response => response.json())
                .then(data => {
                    setTimeout(() => {
                        if (data.message) {
                            showToast(data.message, "success");
                            setTimeout(() => location.reload(), 1000); // Reload trang sau khi x√≥a
                        } else {
                            showToast(data.error, "danger");
                        }
                    }, 500);
                })
                .catch(error => {
                    console.error('L·ªói:', error);
                    setTimeout(() => {
                        showToast("L·ªói khi x√≥a kh√°ch h√†ng!", "danger");
                    }, 500);
                });
        }
    </script>
    <!--API Ph∆∞∆°ng Th·ª©c Thanh To√°n-->
    <script>
        $(document).ready(function () {
            let paymentOptions = $("input[name='phuongThucThanhToanId']");
            let paymentDetails = $("#paymentDetails");
            let paymentMethodText = $("#paymentMethodText");

            // L·∫•y t·ªïng ti·ªÅn h√≥a ƒë∆°n t·ª´ Thymeleaf
            let tongTienHoaDon = parseFloat('[[${hoaDon != null ? hoaDon.tongTien : 0}]]');

            // X·ª≠ l√Ω khi ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
            paymentOptions.on("change", function () {
                let selectedText = $("label[for='" + this.id + "']").text().trim();
                paymentDetails.empty();

                if (selectedText === "Ti·ªÅn M·∫∑t") {
                    paymentDetails.html(`
                <div class="mb-3">
                    <label for="cashAmount" class="form-label"><i class="fas fa-money-bill-wave"></i> Nh·∫≠p s·ªë ti·ªÅn kh√°ch ƒë∆∞a:</label>
                    <input type="number" id="cashAmount" name="cashAmount" class="form-control" placeholder="Nh·∫≠p s·ªë ti·ªÅn kh√°ch ƒë∆∞a" min="0">
                </div>
                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-coins"></i> S·ªë ti·ªÅn th·ªëi l·∫°i:</label>
                    <input type="text" id="changeAmount" class="form-control" readonly>
                </div>
            `);

                    let cashInput = $("#cashAmount");
                    let changeOutput = $("#changeAmount");

                    cashInput.on("input", function () {
                        let cashGiven = parseFloat($(this).val()) || 0;
                        let phiShip = parseFloat($("#phiShip").val()) || 0;
                        let maGiamGia = parseFloat($("#listPhieuGiamGia").val()) || 0;
                        let totalAmount = tongTienHoaDon + phiShip - maGiamGia;

                        let change = cashGiven - totalAmount;
                        changeOutput.val(change < 0 ? `Thi·∫øu ${Math.abs(change).toLocaleString()} VND` : `${change.toLocaleString()} VND`)
                            .css("color", change < 0 ? "red" : "green");
                    });

                } else if (selectedText === "Chuy·ªÉn Kho·∫£n") {
                    paymentDetails.html(`
                <div class="mb-3 text-center">
                    <img id="qrCodeImage" src="http://localhost:8080/images/path-to-qr-code.jpg" alt="QR Code" class="img-fluid" style="max-width: 250px;">
                </div>
            `);
                }
            });

            // X·ª≠ l√Ω khi nh·∫•n n√∫t "C·∫≠p nh·∫≠t" ƒë·ªÉ ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
            $("#addPaymentMethodButton").on("click", function () {
                let formData = $("#paymentMethodForm").serialize();
                let selectedPayment = $("input[name='phuongThucThanhToanId']:checked").val();

                if (!selectedPayment) {
                    showToast("Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!", "error");
                    return;
                }


                $.ajax({
                    url: '/add-payment-method',
                    method: 'POST',
                    data: formData,
                    beforeSend: function () {
                        $("#addPaymentMethodButton").prop("disabled", true);
                    },
                    success: function (response) {
                        setTimeout(() => {
                            if (response.success) {
                                paymentMethodText.text(response.updatedPaymentMethod);
                                $("#paymentModal").modal("hide");
                                showToast("C·∫≠p nh·∫≠t ph∆∞∆°ng th·ª©c thanh to√°n th√†nh c√¥ng!", "success");

                                setTimeout(() => {
                                    location.reload();
                                }, 800);
                            } else {
                                showToast(response.message || "C·∫≠p nh·∫≠t kh√¥ng th√†nh c√¥ng!", "error");
                            }
                        }, 400);
                    },
                    error: function (xhr) {
                        setTimeout(() => {
                            showToast("L·ªói: " + xhr.responseText, "error");
                        }, 400);
                    },
                    complete: function () {
                        $("#addPaymentMethodButton").prop("disabled", false);
                    }
                });
            });
        });

    </script>
    <!--API Thay ƒê·ªïi Lo·∫°i Giao H√†ng v√† Tr·∫£ Sau-->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const deliverySwitch = document.querySelector("#deliverySwitch");
            const payLaterSwitch = document.querySelector("#payLaterSwitch");

            function toggleSections(isChecked) {
                document.getElementById("shippingForm").style.display = isChecked ? "block" : "none";
                document.getElementById("payLaterSection").style.display = isChecked ? "block" : "none";
            }

            if (deliverySwitch) {
                toggleSections(deliverySwitch.checked);
                deliverySwitch.addEventListener("change", function () {
                    toggleSections(this.checked);
                });
            }

            if (payLaterSwitch) {
                payLaterSwitch.addEventListener("change", function () {
                    document.getElementById("payLaterSection").style.display = this.checked ? "block" : "none";
                });
            }

            // G·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t API khi c√≥ thay ƒë·ªïi
            document.querySelectorAll(".form-check-input").forEach((checkbox) => {
                checkbox.addEventListener("change", function () {
                    const hoaDonId = this.getAttribute("data-hoa-don-id");
                    const isChecked = this.checked;

                    const apiUrl = this.id === "deliverySwitch"
                        ? `/api/hoa-don/toggle-delivery/${hoaDonId}`
                        : `/cap-nhat-loai-giao-dich/${hoaDonId}`;

                    fetch(apiUrl, {
                        method: "PUT",
                        headers: {"Content-Type": "application/json"}
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.successMessage) {
                                this.checked = isChecked;
                                if (this.id === "deliverySwitch") {
                                    updateDeliveryUI(this.checked, data.loaiHoaDon);
                                } else {
                                    updateTransactionUI(this.checked, data.loaiGiaoDich);
                                }
                                location.reload(); // Th√™m reload sau khi c·∫≠p nh·∫≠t th√†nh c√¥ng
                            } else {
                                showToast(data.errorMessage || "C·∫≠p nh·∫≠t th·∫•t b·∫°i!", "danger");
                                this.checked = !isChecked;
                            }
                        })
                        .catch(error => {
                            console.error("L·ªói API:", error);
                            showToast("L·ªói k·∫øt n·ªëi ƒë·∫øn server!", "danger");
                            this.checked = !isChecked;
                        });
                });
            });
        });

        // ‚úÖ C·∫≠p nh·∫≠t UI khi thay ƒë·ªïi tr·∫°ng th√°i giao h√†ng
        function updateDeliveryUI(isChecked, loaiHoaDon) {
            document.getElementById("shippingForm").style.display = isChecked ? "block" : "none";
            document.getElementById("payLaterSection").style.display = isChecked ? "block" : "none";
            const orderStatusElement = document.getElementById("orderStatus");
            if (orderStatusElement) orderStatusElement.textContent = loaiHoaDon;

            const confirmModalText = document.querySelector("#confirmModal .modal-body span");
            if (confirmModalText) {
                confirmModalText.textContent = isChecked
                    ? "B·∫°n c√≥ mu·ªën x√°c nh·∫≠n thanh to√°n h√≥a ƒë∆°n giao h√†ng kh√¥ng?"
                    : "B·∫°n c√≥ mu·ªën x√°c nh·∫≠n thanh to√°n h√≥a ƒë∆°n t·∫°i qu·∫ßy kh√¥ng?";
            }
        }

        // ‚úÖ C·∫≠p nh·∫≠t UI khi thay ƒë·ªïi lo·∫°i giao d·ªãch
        function updateTransactionUI(isChecked, loaiGiaoDich) {
            const transactionStatus = document.getElementById("transactionStatus");
            if (transactionStatus) transactionStatus.textContent = loaiGiaoDich;
        }

        // ‚úÖ Hi·ªÉn th·ªã th√¥ng b√°o nhanh
        function showToast(message, type = "success") {
            const toastContainer = document.getElementById("toastContainer");
            if (!toastContainer) return;

            const toast = document.createElement("div");
            toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
            toast.style.position = "absolute";
            toast.style.top = "20px";
            toast.style.right = "20px";
            toast.style.zIndex = "1050";

            toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove("show");
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }
    </script>
    <!--API Phi·∫øu Gi·∫£m Gi√°-->
    <script>
        function applyPhieuGiamGia(button) {
            const hoaDonId = document.getElementById("hoaDonId").value;
            const tenPhieuGiamGia = document.getElementById("tenPhieuGiamGia").value;

            if (!hoaDonId || isNaN(hoaDonId)) {
                showToast("L·ªói: ID h√≥a ƒë∆°n kh√¥ng h·ª£p l·ªá!", "danger");
                return;
            }

            if (!tenPhieuGiamGia) {
                showToast("Vui l√≤ng ch·ªçn phi·∫øu gi·∫£m gi√°.", "warning");
                return;
            }

            button.disabled = true;
            button.innerText = "ƒêang √°p d·ª•ng...";

            fetch('/apply-phieu-giam-gia', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({hoaDonId, tenPhieuGiamGia})
            })
                .then(response => response.json().catch(() => ({
                    success: false,
                    error: "Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá t·ª´ server"
                })))
                .then(data => {
                    if (data.success) {
                        showToast("Phi·∫øu gi·∫£m gi√° ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng!", "success");

                        let modal = bootstrap.Modal.getInstance(document.getElementById("discountModal"));
                        modal.hide();

                        setTimeout(() => {
                            location.reload();
                        }, 500);
                    } else {
                        showToast(data.error || "L·ªói khi √°p d·ª•ng phi·∫øu gi·∫£m gi√°!", "danger");
                    }
                })
                .catch(error => {
                    console.error('L·ªói:', error);
                    showToast("L·ªói h·ªá th·ªëng, vui l√≤ng th·ª≠ l·∫°i sau!", "danger");
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerText = "√Åp d·ª•ng";
                });
        }
    </script>
    <!--API Update ƒê·ªãa Ch·ªâ Giao H√†ng-->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("#updateShippingForm");

            form.addEventListener("submit", function (event) {
                event.preventDefault(); // NgƒÉn ch·∫∑n g·ª≠i form m·∫∑c ƒë·ªãnh

                const formData = new FormData(form);
                const hoaDonId = formData.get("hoaDonId");

                if (!hoaDonId || isNaN(hoaDonId)) {
                    showToast("L·ªói: ID h√≥a ƒë∆°n kh√¥ng h·ª£p l·ªá!", "danger");
                    return;
                }

                fetch("/update-shipping", {
                    method: "PUT",
                    headers: {"Content-Type": "application/x-www-form-urlencoded"},
                    body: new URLSearchParams([...formData])
                })
                    .then(response => {
                        if (!response.ok) { // Ki·ªÉm tra xem ph·∫£n h·ªìi c√≥ th√†nh c√¥ng kh√¥ng
                            throw new Error("Error response from server");
                        }
                        return response.json();
                    })
                    .then(data => {
                        setTimeout(() => {
                            showToast(data.message || data.error, data.message ? "success" : "danger");
                            if (data.message) {
                                setTimeout(() => location.reload(), 1000); // Reload trang sau khi c·∫≠p nh·∫≠t
                            }
                        }, 500);
                    })
                    .catch(error => {
                        console.error("L·ªói:", error);
                        setTimeout(() => {
                            showToast("L·ªói khi c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ giao h√†ng!", "danger");
                        }, 500);
                    });
            });
        });
    </script>
    <!--API Update New Kh√°ch H√†ng-->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("#addCustomerForm");

            form.addEventListener("submit", function (event) {
                event.preventDefault(); // NgƒÉn ch·∫∑n g·ª≠i form m·∫∑c ƒë·ªãnh

                const formData = new FormData(form);
                const hoaDonId = formData.get("hoaDonId");
                const nguoiNhan = formData.get("nguoiNhan");
                const soDienThoai = formData.get("soDienThoai");

                // Ki·ªÉm tra ID h√≥a ƒë∆°n v√† th√¥ng tin ng∆∞·ªùi nh·∫≠n h·ª£p l·ªá
                if (!hoaDonId || isNaN(hoaDonId)) {
                    showToast("L·ªói: ID h√≥a ƒë∆°n kh√¥ng h·ª£p l·ªá!", "danger");
                    return;
                }
                if (!nguoiNhan || nguoiNhan.trim() === "") {
                    showToast("L·ªói: H·ªç t√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", "danger");
                    return;
                }
                if (!soDienThoai || soDienThoai.trim() === "") {
                    showToast("L·ªói: S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", "danger");
                    return;
                }

                // G·ª≠i y√™u c·∫ßu ƒë·∫øn API
                fetch("/add-new-customer", {
                    method: "POST",
                    body: formData,
                })
                    .then(response => {
                        return response.json().then(data => {
                            if (!response.ok) {
                                throw new Error(data.error || "L·ªói t·ª´ server");
                            }
                            return data;
                        });
                    })
                    .then(data => {
                        setTimeout(() => {
                            showToast(data.success || data.error, data.success ? "success" : "danger");
                            if (data.success) {
                                setTimeout(() => location.reload(), 1000); // Reload trang sau khi c·∫≠p nh·∫≠t
                            }
                        }, 500);
                    })
                    .catch(error => {
                        console.error("L·ªói:", error);
                        setTimeout(() => {
                            showToast("L·ªói khi c·∫≠p nh·∫≠t th√¥ng tin kh√°ch h√†ng!", "danger");
                        }, 500);
                    });
            });
        });
    </script>
    <!--API Add S·∫£n Ph·∫©m-->
    <script>
        function addProductOrder(button) {
            const sanPhamChiTietId = parseInt(button.closest('tr').querySelector('td:first-child').textContent.trim(), 10);
            const hoaDonId = parseInt(document.querySelector('input[name="hoaDonId"]').value, 10);
            const soLuong = parseInt(button.closest('tr').querySelector('input[name="soLuong"]').value, 10);

            const data = {
                sanPhamChiTietId: sanPhamChiTietId,
                hoaDonId: hoaDonId,
                soLuong: soLuong
            };

            fetch('/add-product-order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(handleResponse)
                .catch(handleError);

            function handleResponse(response) {
                if (response.successMessage) {
                    showToast(response.successMessage, "success");

                    // L∆∞u v·ªã tr√≠ cu·ªôn tr∆∞·ªõc khi reload
                    sessionStorage.setItem('scrollPosition', window.scrollY);

                    // ƒêi·ªÅu h∆∞·ªõng theo tr·∫°ng th√°i h√≥a ƒë∆°n
                    closeModalAndReload(response.trangThai);
                } else {
                    showToast(response.errorMessage || "ƒê·∫∑t h√†ng th·∫•t b·∫°i!", "danger");
                }
            }

            function handleError(error) {
                console.error("L·ªói khi g·ª≠i y√™u c·∫ßu:", error);
                showToast("C√≥ l·ªói x·∫£y ra: " + error.message, "danger");
            }

            function closeModalAndReload(trangThai) {
                const modalElement = document.getElementById('addProductModal');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                    modal.hide();
                }

                setTimeout(() => {
                    let redirectUrl;
                    if (trangThai === "ƒêang X·ª≠ L√Ω") {
                        redirectUrl = `http://localhost:8080/admin/sell-counter?hoaDonId=${hoaDonId}`;
                    } else if (trangThai === "Ch·ªù X√°c Nh·∫≠n") {
                        redirectUrl = `http://localhost:8080/admin/order-details?hoaDonId=${hoaDonId}`;
                    } else {
                        redirectUrl = `http://localhost:8080/admin/sell-counter?hoaDonId=${hoaDonId}`;
                    }

                    window.location.href = redirectUrl;
                }, 1000);
            }
        }

        // Cu·ªôn v·ªÅ v·ªã tr√≠ ƒë√£ l∆∞u sau khi t·∫£i l·∫°i trang
        window.onload = function () {
            const scrollPosition = sessionStorage.getItem('scrollPosition');
            if (scrollPosition) {
                window.scrollTo({top: parseInt(scrollPosition, 10), behavior: "smooth"});
                sessionStorage.removeItem('scrollPosition'); // X√≥a v·ªã tr√≠ sau khi ƒë√£ cu·ªôn
            }
        };
    </script>
    <!--API Update S·ªë L∆∞·ª£ng-->
    <script>
        function updateQuantityOrder(input) {
            const hoaDonChiTietId = parseInt(input.closest('tr').querySelector('input[name="hoaDonChiTietId"]').value, 10);
            const hoaDonId = parseInt(document.querySelector('input[name="hoaDonId"]').value, 10);
            const soLuong = parseInt(input.value, 10);

            if (isNaN(hoaDonChiTietId) || isNaN(hoaDonId) || isNaN(soLuong) || soLuong < 1) {
                showToast("Th√¥ng tin kh√¥ng h·ª£p l·ªá!", "danger");
                return;
            }

            const data = {
                hoaDonChiTietId: hoaDonChiTietId,
                hoaDonId: hoaDonId,
                soLuong: soLuong
            };


            fetch('/update-product-order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(handleResponse)
                .catch(handleError)
                .finally(() => {
                });

            function handleResponse(response) {
                if (response.successMessage) {
                    showToast(response.successMessage, "success");
                    sessionStorage.setItem('scrollPosition', window.scrollY);
                    closeModalAndReload(response.trangThai);
                } else {
                    showToast(response.errorMessage || "C·∫≠p nh·∫≠t kh√¥ng th√†nh c√¥ng!", "danger");
                }
            }

            function handleError(error) {
                console.error("L·ªói khi g·ª≠i y√™u c·∫ßu:", error);
                showToast("C√≥ l·ªói x·∫£y ra: " + error.message, "danger");
            }

            function closeModalAndReload(trangThai) {
                setTimeout(() => {
                    let toastLoading = document.getElementById("toast-loading");
                    if (toastLoading) {
                        hideToast(toastLoading);
                    }
                    let redirectUrl;
                    if (trangThai === "ƒêang X·ª≠ L√Ω") {
                        redirectUrl = `http://localhost:8080/admin/sell-counter?hoaDonId=${hoaDonId}`;
                    } else if (trangThai === "Ch·ªù X√°c Nh·∫≠n") {
                        redirectUrl = `http://localhost:8080/admin/order-details?hoaDonId=${hoaDonId}`;
                    } else {
                        redirectUrl = `http://localhost:8080/admin/sell-counter?hoaDonId=${hoaDonId}`;
                    }
                    window.location.href = redirectUrl;
                }, 1000);
            }
        }


        function hideToast(toastElement) {
            if (toastElement) {
                try {
                    const toast = new bootstrap.Toast(toastElement);
                    toast.hide();
                } catch (error) {
                    console.warn("Kh√¥ng th·ªÉ ·∫©n toast:", error);
                }
            }
        }

        window.onload = function () {
            const scrollPosition = sessionStorage.getItem('scrollPosition');
            if (scrollPosition) {
                window.scrollTo({top: parseInt(scrollPosition, 10), behavior: "smooth"});
                sessionStorage.removeItem('scrollPosition');
            }
        };
    </script>
    <!--API Delete S·∫£n Ph·∫©m-->
    <script>
        function deleteProductOrder(button) {
            const hoaDonChiTietId = parseInt(button.closest('tr').querySelector('input[name="hoaDonChiTietId"]').value, 10);
            const hoaDonId = parseInt(document.querySelector('input[name="hoaDonId"]').value, 10);

            if (isNaN(hoaDonChiTietId) || isNaN(hoaDonId)) {
                showToast("Th√¥ng tin kh√¥ng h·ª£p l·ªá!", "danger");
                return;
            }

            const data = {
                hoaDonChiTietId: hoaDonChiTietId,
                hoaDonId: hoaDonId
            };


            fetch('/delete-product-order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(handleResponse)
                .catch(handleError)
                .finally(() => {
                });

            function handleResponse(response) {
                if (response.successMessage) {
                    showToast(response.successMessage, "success");
                    sessionStorage.setItem('scrollPosition', window.scrollY);
                    closeModalAndReload(response.trangThai);
                } else {
                    showToast(response.errorMessage || "X√≥a s·∫£n ph·∫©m th·∫•t b·∫°i!", "danger");
                }
            }

            function handleError(error) {
                console.error("L·ªói khi g·ª≠i y√™u c·∫ßu:", error);
                showToast("C√≥ l·ªói x·∫£y ra: " + error.message, "danger");
            }

            function closeModalAndReload(trangThai) {
                const modalElement = document.getElementById('addProductModal');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                    modal.hide();
                }

                setTimeout(() => {
                    let toastLoading = document.getElementById("toast-loading");
                    if (toastLoading) {
                        hideToast(toastLoading);
                    }

                    let redirectUrl;
                    if (trangThai === "ƒêang X·ª≠ L√Ω") {
                        redirectUrl = `http://localhost:8080/admin/sell-counter?hoaDonId=${hoaDonId}`;
                    } else if (trangThai === "Ch·ªù X√°c Nh·∫≠n") {
                        redirectUrl = `http://localhost:8080/admin/order-details?hoaDonId=${hoaDonId}`;
                    } else {
                        redirectUrl = `http://localhost:8080/admin/sell-counter?hoaDonId=${hoaDonId}`;
                    }

                    window.location.href = redirectUrl;
                }, 1000);
            }
        }


        function hideToast(toastElement) {
            if (toastElement) {
                try {
                    const toast = new bootstrap.Toast(toastElement);
                    toast.hide();
                } catch (error) {
                    console.warn("Kh√¥ng th·ªÉ ·∫©n toast:", error);
                }
            }
        }

        // Cu·ªôn v·ªÅ v·ªã tr√≠ ƒë√£ l∆∞u sau khi t·∫£i l·∫°i trang
        window.onload = function () {
            const scrollPosition = sessionStorage.getItem('scrollPosition');
            if (scrollPosition) {
                window.scrollTo({top: parseInt(scrollPosition, 10), behavior: "smooth"});
                sessionStorage.removeItem('scrollPosition');
            }
        };
    </script>
    <!--X√°c Nh·∫≠n Thanh To√°n-->
    <script>
        document.getElementById("confirmPayment").addEventListener("click", function () {
            document.getElementById("paymentForm").submit();
        });
    </script>
    <!--API Giao H√†ng Nhanh-->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const thanhPhoSelect = document.getElementById("thanhPho");
            const huyenSelect = document.getElementById("huyen");
            const phuongSelect = document.getElementById("phuong");

            const thanhPhoHidden = document.getElementById("thanhPhoHidden");
            const huyenHidden = document.getElementById("huyenHidden");
            const phuongHidden = document.getElementById("phuongHidden");

            function fetchProvinces(selectedValue = "") {
                fetch("/api/ghn/provinces")
                    .then(response => response.json())
                    .then(data => {
                        thanhPhoSelect.innerHTML = '<option value="">Ch·ªçn T·ªânh/Th√†nh ph·ªë</option>';
                        let selectedProvinceId = "";

                        data.data.forEach(province => {
                            const selected = province.ProvinceName === selectedValue ? "selected" : "";
                            if (selected) selectedProvinceId = province.ProvinceID;
                            thanhPhoSelect.innerHTML += `<option value="${province.ProvinceName}" data-id="${province.ProvinceID}" ${selected}>${province.ProvinceName}</option>`;
                        });

                        if (selectedProvinceId) fetchDistricts(selectedProvinceId, huyenHidden.value);
                    })
                    .catch(error => console.error("L·ªói khi l·∫•y danh s√°ch t·ªânh/th√†nh ph·ªë:", error));
            }

            function fetchDistricts(provinceId, selectedValue = "") {
                fetch(`/api/ghn/districts?province_id=${provinceId}`)
                    .then(response => response.json())
                    .then(data => {
                        huyenSelect.innerHTML = '<option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>';
                        let selectedDistrictId = "";

                        data.data.forEach(district => {
                            const selected = district.DistrictName === selectedValue ? "selected" : "";
                            if (selected) selectedDistrictId = district.DistrictID;
                            huyenSelect.innerHTML += `<option value="${district.DistrictName}" data-id="${district.DistrictID}" ${selected}>${district.DistrictName}</option>`;
                        });

                        if (selectedDistrictId) fetchWards(selectedDistrictId, phuongHidden.value);
                    })
                    .catch(error => console.error("L·ªói khi l·∫•y danh s√°ch qu·∫≠n/huy·ªán:", error));
            }

            function fetchWards(districtId, selectedValue = "") {
                fetch(`/api/ghn/wards?district_id=${districtId}`)
                    .then(response => response.json())
                    .then(data => {
                        phuongSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';

                        data.data.forEach(ward => {
                            const selected = ward.WardName === selectedValue ? "selected" : "";
                            phuongSelect.innerHTML += `<option value="${ward.WardName}" data-id="${ward.WardCode}" ${selected}>${ward.WardName}</option>`;
                        });
                    })
                    .catch(error => console.error("L·ªói khi l·∫•y danh s√°ch ph∆∞·ªùng/x√£:", error));
            }

            // C·∫≠p nh·∫≠t gi√° tr·ªã ·∫©n khi thay ƒë·ªïi l·ª±a ch·ªçn
            thanhPhoSelect.addEventListener("change", function () {
                const selectedOption = this.options[this.selectedIndex];
                const provinceId = selectedOption.getAttribute("data-id");

                thanhPhoHidden.value = selectedOption.value;
                huyenHidden.value = "";
                phuongHidden.value = "";

                huyenSelect.innerHTML = '<option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>';
                phuongSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';

                if (provinceId) {
                    fetchDistricts(provinceId);
                }
            });

            huyenSelect.addEventListener("change", function () {
                const selectedOption = this.options[this.selectedIndex];
                const districtId = selectedOption.getAttribute("data-id");

                huyenHidden.value = selectedOption.value;
                phuongHidden.value = "";

                phuongSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';

                if (districtId) {
                    fetchWards(districtId);
                }
            });

            phuongSelect.addEventListener("change", function () {
                phuongHidden.value = this.value;
            });

            // N·∫øu c√≥ d·ªØ li·ªáu c≈©, hi·ªÉn th·ªã tr∆∞·ªõc r·ªìi cho ph√©p thay ƒë·ªïi
            if (thanhPhoHidden.value) {
                fetchProvinces(thanhPhoHidden.value);
            } else {
                fetchProvinces();
            }
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('hidden.bs.modal', function () {
                    let backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = 'auto';
                });
            });
        });

    </script>
    <!--Validate-->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const addCustomerForm = document.getElementById("addCustomerForm");
            const hoaDonId = addCustomerForm?.getAttribute("data-hoa-don-id");

            // Ch·ªâ ch·∫°y n·∫øu hoaDonId h·ª£p l·ªá
            if (!hoaDonId || isNaN(hoaDonId) || hoaDonId.trim() === "") {
                return;
            }

            addCustomerForm.addEventListener("submit", function (event) {
                let isValid = true;

                // L·∫•y gi√° tr·ªã input
                let nguoiNhan = document.getElementById("nguoiNhan").value.trim();
                let soDienThoai = document.getElementById("soDienThoai").value.trim();

                // X√≥a th√¥ng b√°o l·ªói c≈©
                document.getElementById("nguoiNhanError").innerText = "";
                document.getElementById("soDienThoaiError").innerText = "";

                // Ki·ªÉm tra h·ªç t√™n (ph·∫£i c√≥ √≠t nh·∫•t 2 t·ª´)
                if (nguoiNhan === "") {
                    document.getElementById("nguoiNhanError").innerText = "H·ªç t√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.";
                    isValid = false;
                } else if (!/^[A-Za-z√Ä-·ªπ\s]+$/.test(nguoiNhan)) {
                    document.getElementById("nguoiNhanError").innerText = "H·ªç t√™n ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i.";
                    isValid = false;
                } else if (!/^\S+\s+\S+/.test(nguoiNhan)) {
                    document.getElementById("nguoiNhanError").innerText = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß h·ªç v√† t√™n.";
                    isValid = false;
                }

                // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i (10-11 ch·ªØ s·ªë)
                if (!/^\d{10,11}$/.test(soDienThoai)) {
                    document.getElementById("soDienThoaiError").innerText = "S·ªë ƒëi·ªán tho·∫°i ph·∫£i t·ª´ 10-11 s·ªë.";
                    isValid = false;
                }

                // N·∫øu c√≥ l·ªói, ngƒÉn form submit
                if (!isValid) {
                    event.preventDefault();
                }
            });
        });
    </script>
    <!--Load table-->
    <script>
        $(document).ready(function () {
            $('#productTable').DataTable({
                "paging": true,
                "lengthMenu": [5, 10, 20],
                "pageLength": 5,
                "autoWidth": false,
                "responsive": true,
                "language": {
                    "sProcessing": "ƒêang x·ª≠ l√Ω...",
                    "sLengthMenu": "Hi·ªÉn th·ªã _MENU_ d√≤ng",
                    "sZeroRecords": "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu",
                    "sInfo": "Hi·ªÉn th·ªã _START_ ƒë·∫øn _END_ trong t·ªïng _TOTAL_ d√≤ng",
                    "sInfoEmpty": "Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã",
                    "sInfoFiltered": "(l·ªçc t·ª´ _MAX_ d√≤ng)",
                    "sSearch": "T√¨m ki·∫øm:",
                    "oPaginate": {
                        "sFirst": "ƒê·∫ßu",
                        "sPrevious": "Tr∆∞·ªõc",
                        "sNext": "Ti·∫øp",
                        "sLast": "Cu·ªëi"
                    }
                }
            });
        });
    </script>
</div>