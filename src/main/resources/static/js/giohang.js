document.addEventListener("DOMContentLoaded", function () {
    renderCart();
    console.log("üõí Gi·ªè h√†ng khi t·∫£i trang:", JSON.parse(localStorage.getItem("cart")));

    document.getElementById("cart-body").addEventListener("click", function (event) {
        let row = event.target.closest("tr");
        if (!row) return;

        let idSanPhamChiTiet = row.dataset.idsanphamchitiet;
        let size = row.dataset.size;
        let color = row.dataset.color;

        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        let product = cart.find(item =>
            item.idSanPhamChiTiet == idSanPhamChiTiet &&
            item.size == size &&
            item.color == color
        );

        if (!product) return;

        if (event.target.classList.contains("btn-plus")) {
            if (product.quantity < product.availableQuantity) {
                product.quantity += 1;
            } else {
                Swal.fire({
                    icon: "warning",
                    title: "Kh√¥ng ƒë·ªß h√†ng!",
                    text: `Ch·ªâ c√≤n ${product.availableQuantity - product.quantity} s·∫£n ph·∫©m trong kho.`,
                    confirmButtonText: "OK"
                });
            }
        } else if (event.target.classList.contains("btn-minus")) {
            if (product.quantity > 1) {
                product.quantity -= 1;
            }
        } else if (event.target.classList.contains("btn-remove")) {
            cart = cart.filter(item => !(item.idSanPhamChiTiet == idSanPhamChiTiet && item.size == size && item.color == color));
        }

        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
    });

    document.getElementById("checkout-button").addEventListener("click", function (event) {
        event.preventDefault();

        let cart = localStorage.getItem("cart");
        if (!cart) return;

        let discountCode = localStorage.getItem("discountCode") || null;
        let discountId = localStorage.getItem("discountId") || null;
        let discountValue = localStorage.getItem("discountValue") || "0";
        let shippingFee = document.getElementById("shipping-fee").textContent.trim();
        let totalAmount = document.getElementById("total").textContent.trim();

        sessionStorage.setItem("checkoutCart", JSON.stringify({
            cart: JSON.parse(cart),
            discount: discountCode ? { id: discountId, code: discountCode, value: parseInt(discountValue.replace(/\D/g, "")) } : { id: null, code: null, value: 0 },
            shippingFee,
            total: totalAmount
        }));

        window.location.href = "thanh-toan";
    });

});

function renderCart() {
    let cartData = localStorage.getItem("cart");
    let cartBody = document.querySelector("#cart-body");
    let subtotal = 0;
    cartBody.innerHTML = "";

    if (!cartData || JSON.parse(cartData).length === 0) {
        cartBody.innerHTML = `<tr><td colspan="7" class="text-center">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</td></tr>`;
        document.getElementById("subtotal").innerText = "0 VND";
        document.getElementById("total").innerText = "0 VND";
        document.getElementById("shipping-fee").innerText = "0 VND";
        return;
    }

    let cart = JSON.parse(cartData);
    cart.forEach((item, index) => {
        let price = Number(item.price.toString().replace(/\D/g, ""));
        let total = price * item.quantity;
        subtotal += total;

        cartBody.innerHTML += `
<tr data-idsanphamchitiet="${item.idSanPhamChiTiet}" data-size="${item.size}" data-color="${item.color}">
    <td class="align-middle">${index + 1}</td>
    <td class="align-middle">
        <img src="${item.image || 'default.jpg'}" alt="·∫¢nh s·∫£n ph·∫©m" style="width: 50px; height: 50px; object-fit: cover;">
    </td>
    <td class="align-middle">${item.name || "S·∫£n ph·∫©m kh√¥ng x√°c ƒë·ªãnh"}</td>
    <td class="align-middle">
        M√†u: ${item.color || "Kh√¥ng r√µ"}, Size: ${item.size || "Kh√¥ng r√µ"}
        <br> <small class="text-muted">T·ªìn kho: ${item.availableQuantity - item.quantity}</small>
    </td>
    <td class="align-middle">
        <div class="input-group quantity mx-auto" style="width: 100px;">
            <div class="input-group-btn">
                <button class="btn btn-sm btn-primary btn-minus"><i class="fa fa-minus"></i></button>
            </div>
            <input type="text" class="form-control form-control-sm bg-secondary text-center quantity-input" value="${item.quantity}" readonly>
            <div class="input-group-btn">
                <button class="btn btn-sm btn-primary btn-plus"><i class="fa fa-plus"></i></button>
            </div>
        </div>
    </td>
    <td class="align-middle">${price.toLocaleString('vi-VN')} VND</td>
    <td class="align-middle">${total.toLocaleString('vi-VN')} VND</td>
    <td class="align-middle">
        <button class="btn btn-sm btn-danger btn-remove"><i class="fa fa-times"></i></button>
    </td>
</tr>
`;
    });

    let shippingFee = cart.length > 0 ? 30000 : 0;
    document.getElementById("shipping-fee").innerText = shippingFee.toLocaleString('vi-VN') + " VND";
    document.getElementById("subtotal").innerText = subtotal.toLocaleString('vi-VN') + " VND";
    document.getElementById("total").innerText = (subtotal + shippingFee).toLocaleString('vi-VN') + " VND";
}
function getCartTotal() {
    return Number(document.getElementById("subtotal").innerText.replace(/\D/g, ""));
}


async function fetchCoupons() {
    try {
        const response = await fetch('http://localhost:8080/api/phieu-giam-gia?trangThai=%C4%90ang%20Ho%E1%BA%A1t%20%C4%90%E1%BB%99ng');
        let coupons = await response.json();

        let cartTotal = getCartTotal(); // L·∫•y t·ªïng ti·ªÅn gi·ªè h√†ng

        // L·ªçc ra phi·∫øu ƒë·ªß ƒëi·ªÅu ki·ªán v√† kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán
        let eligibleCoupons = coupons.filter(coupon => cartTotal >= coupon.dieuKien);
        let ineligibleCoupons = coupons.filter(coupon => cartTotal < coupon.dieuKien);

        // S·∫Øp x·∫øp gi·∫£m d·∫ßn theo gi√° tr·ªã gi·∫£m
        eligibleCoupons.sort((a, b) => b.giaTriGiam - a.giaTriGiam);
        ineligibleCoupons.sort((a, b) => b.giaTriGiam - a.giaTriGiam);

        // K·∫øt h·ª£p danh s√°ch: ∆∞u ti√™n hi·ªÉn th·ªã phi·∫øu ƒë·ªß ƒëi·ªÅu ki·ªán tr∆∞·ªõc
        let sortedCoupons = [...eligibleCoupons, ...ineligibleCoupons];

        renderCoupons(sortedCoupons);
    } catch (error) {
        console.error('L·ªói khi t·∫£i phi·∫øu gi·∫£m gi√°:', error);
    }
}



function renderCoupons(coupons) {
    const container = document.getElementById('coupon-container');
    container.innerHTML = '';

    let cartTotal = getCartTotal(); // L·∫•y t·ªïng ƒë∆°n h√†ng hi·ªán t·∫°i
    console.log("üîπ T·ªïng ƒë∆°n h√†ng:", cartTotal);

    const maxVisibleCoupons = 3;
    let showAll = false;

    function updateTotal(discountValue = 0) {
        let subtotal = getCartTotal();
        let shippingFee = Number(document.getElementById("shipping-fee").innerText.replace(/\D/g, ""));
        let finalTotal = subtotal + shippingFee - discountValue;

        document.getElementById("total").innerText = `${finalTotal.toLocaleString()} VND`;

        const discountContainer = document.getElementById("discount-container");
        const discountDisplay = document.getElementById("discount-display");

        if (discountValue > 0) {
            discountContainer.style.display = 'flex';
            discountDisplay.innerText = `-${discountValue.toLocaleString()} VND`;
        } else {
            // üöÄ Reset v√™ÃÄ mƒÉÃ£c ƒëiÃ£nh
            discountContainer.style.display = 'none';
            discountDisplay.innerText = "-0 VND";
        }
    }

    function updateView() {
        container.innerHTML = '';
        const displayedCoupons = showAll ? coupons : coupons.slice(0, maxVisibleCoupons);

        displayedCoupons.forEach(coupon => {
            let isEligible = cartTotal >= coupon.dieuKien;

            const couponElement = document.createElement('div');
            couponElement.classList.add('coupon');
            couponElement.innerHTML = `
            <div class="coupon-left">${coupon.giaTriGiam.toLocaleString()} ${coupon.donViTinh}</div>
            <div class="coupon-right">
                <div class="coupon-title">${coupon.tenPhieuGiamGia} - <strong>${coupon.maPhieuGiamGia}</strong></div>
                <div class="coupon-condition">ƒê∆°n h√†ng t·ª´ ${coupon.dieuKien.toLocaleString()} ${coupon.donViTinh}</div>
            </div>
            <input type="radio" name="coupon" class="coupon-select" value="${coupon.maPhieuGiamGia}" data-value="${coupon.giaTriGiam}" ${isEligible ? '' : 'disabled'}>
        `;
            container.appendChild(couponElement);

            // üåü Th√™m s·ª± ki·ªán click ƒë·ªÉ ch·ªçn/b·ªè ch·ªçn radio, nh∆∞ng ch·∫∑n n·∫øu radio b·ªã disabled
            couponElement.addEventListener('click', function (event) {
                let radio = couponElement.querySelector(".coupon-select");

                if (radio.disabled) {
                    Swal.fire({
                        icon: "error",
                        title: "Phi·∫øu kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán!",
                        text: "Gi·ªè h√†ng c·ªßa b·∫°n ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán ƒë·ªÉ √°p d·ª•ng phi·∫øu gi·∫£m gi√° n√†y.",
                        confirmButtonText: "OK"
                    });
                    return;
                }

                if (event.target.classList.contains("coupon-select")) return; // N·∫øu b·∫•m v√†o ch√≠nh radio th√¨ b·ªè qua

                if (radio.checked) {
                    radio.checked = false;
                    localStorage.removeItem("discountCode");
                    localStorage.removeItem("discountValue");
                    localStorage.removeItem("discountId");
                    updateTotal(0);
                } else {
                    // B·ªè ch·ªçn c√°c radio kh√°c tr∆∞·ªõc khi ch·ªçn c√°i m·ªõi
                    document.querySelectorAll(".coupon-select").forEach(r => r.checked = false);

                    radio.checked = true;
                    localStorage.setItem("discountCode", radio.value);
                    localStorage.setItem("discountValue", radio.getAttribute("data-value"));
                    localStorage.setItem("discountId", coupon.id);
                    updateTotal(Number(radio.getAttribute("data-value")));
                }
            });
        });

        // X·ª≠ l√Ω n√∫t "Xem th√™m"
        if (coupons.length > maxVisibleCoupons) {
            const seeMoreButton = document.createElement('div');
            seeMoreButton.innerText = showAll ? "Thu g·ªçn" : "Xem th√™m";
            seeMoreButton.classList.add("see-more-btn");
            seeMoreButton.onclick = function () {
                showAll = !showAll;
                updateView();
            };
            container.appendChild(seeMoreButton);
        }
    }

    updateView();
}

// C·∫≠p nh·∫≠t danh s√°ch phi·∫øu khi gi·ªè h√†ng thay ƒë·ªïi
document.addEventListener("DOMContentLoaded", function () {
    renderCart();
    fetchCoupons();
});

document.getElementById("cart-body").addEventListener("click", function () {
    setTimeout(() => {
        fetchCoupons(); // C·∫≠p nh·∫≠t phi·∫øu khi thay ƒë·ªïi s·ªë l∆∞·ª£ng gi·ªè h√†ng
    }, 500);
});

