package com.example.datn_trendsetter.API;

import aj.org.objectweb.asm.TypeReference;
import com.example.datn_trendsetter.DTO.ProductOrderRequest;
import com.example.datn_trendsetter.DTO.SanPhamChiTietDTO;
import com.example.datn_trendsetter.Entity.DiaChi;
import com.example.datn_trendsetter.Entity.HoaDon;
import com.example.datn_trendsetter.Entity.KhachHang;
import com.example.datn_trendsetter.Entity.NhanVien;
import com.example.datn_trendsetter.Repository.HoaDonRepository;
import com.example.datn_trendsetter.Repository.KhachHangRepository;
import com.example.datn_trendsetter.Repository.SanPhamChiTietRepository;
import com.example.datn_trendsetter.Service.ShopService;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.servlet.http.HttpSession;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.*;

@RestController
public class ShopApiController {
    @Autowired
    private HoaDonRepository hoaDonRepository;

    @Autowired
    private ShopService shopService;

    @Autowired
    private KhachHangRepository khachHangRepository;

    @PostMapping("/create")
    public ResponseEntity<?> createHoaDon(HttpSession session) {
        try {
            // L·∫•y tr·ª±c ti·∫øp ƒë·ªëi t∆∞·ª£ng NhanVien t·ª´ session
            NhanVien nhanVien = (NhanVien) session.getAttribute("userNhanVien");

            if (nhanVien == null) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                        .body(Map.of("message", "Vui l√≤ng ƒëƒÉng nh·∫≠p"));
            }

            // T·∫°o h√≥a ƒë∆°n m·ªõi
            HoaDon hoaDon = new HoaDon();
            HoaDon createdHoaDon = shopService.createHoaDon(hoaDon, nhanVien.getId());

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "id", createdHoaDon.getId(),
                    "maHoaDon", createdHoaDon.getMaHoaDon(),
                    "message", "T·∫°o h√≥a ƒë∆°n th√†nh c√¥ng"
            ));

        } catch (ClassCastException e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(Map.of("message", "ƒê·ªãnh d·∫°ng session kh√¥ng h·ª£p l·ªá"));
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(Map.of("message", "L·ªói server: " + e.getMessage()));
        }
    }


    @PostMapping("delete/{id}")
    public ResponseEntity<Map<String, String>> deleteHoaDon(@PathVariable("id") Integer hoaDonId, HttpSession session) {
        Map<String, String> response = new HashMap<>();
        try {
            // L·∫•y tr·ª±c ti·∫øp ƒë·ªëi t∆∞·ª£ng NhanVien t·ª´ session
            NhanVien nhanVien = (NhanVien) session.getAttribute("userNhanVien");

            if (nhanVien == null) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                        .body(Map.of("message", "Vui l√≤ng ƒëƒÉng nh·∫≠p"));
            }

            shopService.deleteHoaDon(hoaDonId);
            response.put("message", "üóëÔ∏è H√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c x√≥a!");
            return ResponseEntity.ok(response);
        } catch (RuntimeException e) {
            response.put("error", "üö® " + e.getMessage());
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        } catch (Exception e) {
            response.put("error", "‚ùå L·ªói khi x√≥a h√≥a ƒë∆°n: " + e.getMessage());
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
        }
    }

    @PostMapping("/add-customer")
    public ResponseEntity<?> addCustomerToInvoice(@RequestParam("hoaDonId") Integer hoaDonId,
                                                  @RequestParam("khachHangId") Integer khachHangId,
                                                  HttpSession session) {
        try {
            // L·∫•y tr·ª±c ti·∫øp ƒë·ªëi t∆∞·ª£ng NhanVien t·ª´ session
            NhanVien nhanVien = (NhanVien) session.getAttribute("userNhanVien");

            if (nhanVien == null) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                        .body(Map.of("message", "Vui l√≤ng ƒëƒÉng nh·∫≠p"));
            }

            // T√¨m kh√°ch h√†ng t·ª´ khachHangId
            KhachHang khachHang = khachHangRepository.findById(khachHangId)
                    .orElseThrow(() -> new IllegalArgumentException("Kh√°ch h√†ng kh√¥ng t·ªìn t·∫°i!"));

            // G·ªçi service ƒë·ªÉ th√™m kh√°ch h√†ng v√†o h√≥a ƒë∆°n
            String message = shopService.addCustomerToInvoice(hoaDonId, khachHang);
            return ResponseEntity.ok(Collections.singletonMap("message", message));
        } catch (IllegalArgumentException e) {
            return ResponseEntity.badRequest().body(Collections.singletonMap("error", e.getMessage()));
        }
    }


    @PostMapping("/delete-customer")
    public ResponseEntity<Map<String, String>> deleteCustomerToInvoice(@RequestParam("hoaDonId") Integer hoaDonId) {
        Map<String, String> response = shopService.deleteCustomerToInvoice(hoaDonId);
        return response.containsKey("error") ?
                ResponseEntity.badRequest().body(response) :
                ResponseEntity.ok(response);
    }

    @PostMapping("add-payment-method")
    @ResponseBody
    public ResponseEntity<Map<String, String>> addPaymentMethod(@RequestParam("hoaDonId") Integer hoaDonId,
                                                                @RequestParam("phuongThucThanhToanId") Integer phuongThucThanhToanId) {
        try {
            Map<String, String> response = shopService.updatePaymentMethod(hoaDonId, phuongThucThanhToanId);
            return ResponseEntity.ok(response);
        } catch (IllegalArgumentException e) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(Map.of("error", e.getMessage()));
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of("error", "C√≥ l·ªói x·∫£y ra trong h·ªá th·ªëng"));
        }
    }

    @PostMapping("/apply-phieu-giam-gia")
    public ResponseEntity<Map<String, Object>> applyPhieuGiamGia(
            @RequestParam("hoaDonId") Integer hoaDonId,
            @RequestParam(value = "tenPhieuGiamGia", required = false) String tenPhieuGiamGia) {

        Map<String, Object> response = new HashMap<>();
        try {
            if (hoaDonId == null) {
                throw new IllegalArgumentException("ID h√≥a ƒë∆°n kh√¥ng h·ª£p l·ªá.");
            }

            // G·ª≠i xu·ªëng service, ch·∫•p nh·∫≠n c·∫£ tr∆∞·ªùng h·ª£p tenPhieuGiamGia r·ªóng (b·ªè gi·∫£m gi√°)
            String message = shopService.applyPhieuGiamGia(hoaDonId, (tenPhieuGiamGia != null) ? tenPhieuGiamGia.trim() : "");

            response.put("success", true);
            response.put("message", message);
            return ResponseEntity.ok(response);
        } catch (IllegalArgumentException e) {
            response.put("success", false);
            response.put("error", e.getMessage());
            return ResponseEntity.badRequest().body(response);
        } catch (RuntimeException e) {
            response.put("success", false);
            response.put("error", "L·ªói h·ªá th·ªëng: " + e.getMessage());
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
        }
    }



    @PutMapping("/update-shipping")
    public ResponseEntity<Map<String, String>> updateShipping(@RequestParam Integer hoaDonId,
                                                              @RequestParam String nguoiNhan,
                                                              @RequestParam String soDienThoai,
                                                              @RequestParam String diaChiCuThe,
                                                              @RequestParam String phuong,
                                                              @RequestParam String huyen,
                                                              @RequestParam String thanhPho,
                                                              @RequestParam String ghiChu) {
        Map<String, String> response = new HashMap<>();
        try {
            String message = shopService.updateShippingAddress(hoaDonId, nguoiNhan, soDienThoai, diaChiCuThe, phuong, huyen, thanhPho, ghiChu);
            response.put("message", message);
            return ResponseEntity.ok(response);
        } catch (RuntimeException e) {
            response.put("error", e.getMessage()); // Tr·∫£ v·ªÅ th√¥ng b√°o l·ªói
            return ResponseEntity.badRequest().body(response); // Tr·∫£ v·ªÅ m√£ l·ªói 400 v·ªõi th√¥ng ƒëi·ªáp
        }
    }



    @PostMapping("/add-new-customer")
    public ResponseEntity<Map<String, Object>> addNewCustomer(@RequestParam("hoaDonId") Integer hoaDonId,
                                                              @RequestParam("nguoiNhan") String nguoiNhan,
                                                              @RequestParam("soDienThoai") String soDienThoai) {
        Map<String, Object> response = shopService.addNewCustomer(hoaDonId, nguoiNhan, soDienThoai);

        // N·∫øu tr·∫°ng th√°i kh√¥ng ph·∫£i success th√¨ tr·∫£ v·ªÅ Bad Request
        if (!"success".equals(response.get("status"))) {
            return ResponseEntity.badRequest().body(response);
        }

        return ResponseEntity.ok(response);
    }

    @PostMapping("/add-product-order")
    public ResponseEntity<Map<String,String>> addProductOrder(@RequestBody ProductOrderRequest orderRequest) {
        Integer sanPhamChiTietId = orderRequest.getSanPhamChiTietId();
        Integer hoaDonId = orderRequest.getHoaDonId();
        Integer soLuong = orderRequest.getSoLuong();

        return shopService.handleProductOrder("add", sanPhamChiTietId, hoaDonId, soLuong, null);
    }


    @PostMapping("update-product-order")
    public ResponseEntity<Map<String,String>> updateQuantityOrder(@RequestBody ProductOrderRequest orderRequest) {

        return shopService.handleProductOrder("update", null, orderRequest.getHoaDonId(), orderRequest.getSoLuong(), orderRequest.getHoaDonChiTietId());
    }


    @PostMapping("delete-product-order")
    public ResponseEntity<Map<String,String>> deleteProductOrder(@RequestBody ProductOrderRequest orderRequest) {
        return shopService.handleProductOrder("delete", null, orderRequest.getHoaDonId(), null,orderRequest.getHoaDonChiTietId());
    }
    @PutMapping("/cap-nhat-loai-giao-dich/{id}")
    public ResponseEntity<Map<String, Object>> capNhatLoaiGiaoDich(@PathVariable Integer id, HttpSession session) {
        Map<String, Object> response = new HashMap<>();
        try {
            // L·∫•y tr·ª±c ti·∫øp ƒë·ªëi t∆∞·ª£ng NhanVien t·ª´ session
            NhanVien nhanVien = (NhanVien) session.getAttribute("userNhanVien");

            if (nhanVien == null) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                        .body(Map.of("message", "Vui l√≤ng ƒëƒÉng nh·∫≠p"));
            }

            Optional<HoaDon> hoaDonOpt = hoaDonRepository.findById(id);
            if (hoaDonOpt.isEmpty()) {
                response.put("errorMessage", "H√≥a ƒë∆°n kh√¥ng t·ªìn t·∫°i!");
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(response);
            }

            HoaDon hoaDon = hoaDonOpt.get();

//            // Ki·ªÉm tra xem nh√¢n vi√™n hi·ªán t·∫°i c√≥ ph·∫£i l√† ng∆∞·ªùi t·∫°o h√≥a ƒë∆°n kh√¥ng
//            NhanVien currentNhanVien = (NhanVien) user;
//            if (!currentNhanVien.equals(hoaDon.getNhanVien())) {
//                response.put("errorMessage", "B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a h√≥a ƒë∆°n n√†y");
//                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(response);
//            }

            if ("T·∫°i Qu·∫ßy".equals(hoaDon.getLoaiHoaDon())) {
                hoaDon.setPhiShip(null);
            } else if ("Giao H√†ng".equals(hoaDon.getLoaiHoaDon())) {
                if (hoaDon.getNguoiNhan() != null && hoaDon.getSoDienThoai() != null) {
                    hoaDon.setPhiShip(30000F);
                } else {
                    hoaDon.setPhiShip(0F);
                }
            } else {
                response.put("errorMessage", "Lo·∫°i h√≥a ƒë∆°n kh√¥ng h·ª£p l·ªá!");
                return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
            }

            hoaDon.setLoaiGiaoDich("Tr·∫£ Sau".equals(hoaDon.getLoaiGiaoDich()) ? "Tr·∫£ Tr∆∞·ªõc" : "Tr·∫£ Sau");
            hoaDonRepository.save(hoaDon);

            response.put("successMessage", "C·∫≠p nh·∫≠t lo·∫°i giao d·ªãch th√†nh c√¥ng!");
            response.put("loaiGiaoDich", hoaDon.getLoaiGiaoDich());
            response.put("phiShip", hoaDon.getPhiShip());

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            response.put("errorMessage", "L·ªói c·∫≠p nh·∫≠t lo·∫°i giao d·ªãch!");
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
        }
    }

}
